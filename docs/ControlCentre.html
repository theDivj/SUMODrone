<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>ControlCentre API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#ControlCentre">ControlCentre</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ControlCentre.__init__">ControlCentre</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.wEnergy">wEnergy</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.wUrgency">wUrgency</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.proximityRadius">proximityRadius</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.maxDrones">maxDrones</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.requests">requests</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.allocatedEV">allocatedEV</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.startChargeEV">startChargeEV</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.allocatedDrone">allocatedDrone</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.freeDrones">freeDrones</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.needChargeDrones">needChargeDrones</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.droneType">droneType</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.spawnedDrones">spawnedDrones</a>
                        </li>
                        <li>
                                <a class="variable" href="#ControlCentre.insertedDummies">insertedDummies</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.allocate">allocate</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.allocateDrones">allocateDrones</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.calcUrgency">calcUrgency</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.findEdgePos">findEdgePos</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.findRendezvousXY">findRendezvousXY</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.getNeighboursNeedingCharge">getNeighboursNeedingCharge</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.notifyDroneState">notifyDroneState</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.notifyEVState">notifyEVState</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.printDroneStatistics">printDroneStatistics</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.requestCharge">requestCharge</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.setMaxDrones">setMaxDrones</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.syncSpawnedDrones">syncSpawnedDrones</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.tidyDrones">tidyDrones</a>
                        </li>
                        <li>
                                <a class="function" href="#ControlCentre.update">update</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
ControlCentre    </h1>

                        <div class="docstring"><p>Module managing allocation of Drones to EVs and control (parking, charging) of Drones when not assigned to EVs</p>
</div>

                        <input id="mod-ControlCentre-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ControlCentre-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Module managing allocation of Drones to EVs and control (parking, charging) of Drones when not assigned to EVs&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">traci</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">GlobalClasses</span> <span class="kn">import</span> <span class="n">GlobalClasses</span> <span class="k">as</span> <span class="n">GG</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">EV</span> <span class="kn">import</span> <span class="n">EV</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">Drone</span> <span class="kn">import</span> <span class="n">Drone</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="k">class</span> <span class="nc">ControlCentre</span><span class="p">:</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class receiving requests from EV&#39;s and notifications from Drones and EV&#39;s when charge completes or Drone is out of battery&quot;&quot;&quot;</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wEnergy</span><span class="p">,</span> <span class="n">wUrgency</span><span class="p">,</span> <span class="n">proximityRadius</span><span class="p">,</span> <span class="n">maxDrones</span><span class="p">,</span> <span class="n">droneType</span><span class="o">=</span><span class="s2">&quot;ehang184&quot;</span><span class="p">):</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wEnergy</span><span class="p">)</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wUrgency</span><span class="p">)</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span> <span class="o">=</span> <span class="n">proximityRadius</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">=</span> <span class="n">maxDrones</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">droneType</span> <span class="o">=</span> <span class="n">droneType</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">insertedDummies</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the mapping between drone and ev&quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">drone</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">findRendezvousXY</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">drone</span><span class="p">))</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="n">requestedWh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="n">drone</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">requestedWh</span><span class="p">)</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="c1">#print(&quot;allocation&quot;, GG.ss.timeStep, drone.getID(), ev.getID())</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="k">def</span> <span class="nf">allocateDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urgencyList</span><span class="p">):</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate whatever drones we have free/viable in order of urgency,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            if more than one drone available assign the nearest&quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="n">ld</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="n">nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="k">if</span> <span class="n">ld</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>                <span class="k">break</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="k">elif</span> <span class="n">ld</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>                <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>                <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>                <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>                    <span class="k">break</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="k">elif</span> <span class="n">ld</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># need to find drone nearest the ev before we allocate</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>                <span class="n">nearestDrone</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>                <span class="n">evDistance</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>                    <span class="n">dronePos</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">dronePos</span><span class="p">)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">evDistance</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>                        <span class="n">nearestDrone</span> <span class="o">=</span> <span class="n">drone</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>                        <span class="n">evDistance</span> <span class="o">=</span> <span class="n">distance</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>                <span class="k">if</span> <span class="n">nearestDrone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">nearestDrone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nearestDrone</span><span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>                <span class="k">elif</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>                    <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>                    <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>                    <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>                        <span class="k">break</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="k">else</span><span class="p">:</span>   <span class="c1"># ld == 0 nd &gt;0</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>                <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>                <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>                <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>                    <span class="k">break</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>    <span class="k">def</span> <span class="nf">calcUrgency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;urgency defined as distance to nearest hub/distance ev can travel on charge.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">            creates a list of ev&#39;s that want charge, have not been allocated a drone</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="n">urgencyList</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>          <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>            <span class="n">urgencyList</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>            <span class="n">firstCall</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>                <span class="c1"># note drivingDistance can be very large -  float max if there is no hub on the remaining route</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>                <span class="n">evID</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>                    <span class="n">ev</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>                <span class="n">hub</span><span class="p">,</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">findNearestHub</span><span class="p">(</span><span class="n">evPos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evPos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                <span class="c1"># hub, hubDistance = GG.ch.findNearestHubDriving(evID)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                <span class="n">evRange</span> <span class="o">=</span> <span class="mf">200.0</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># if we have an ugency weight then we need to calculate the range</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getDistance</span><span class="p">(</span><span class="n">evID</span><span class="p">))</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>  <span class="c1"># can compute real range after we&#39;ve been driving for a while - arbitrary 10km</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                        <span class="n">mWh</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.totalEnergyConsumed&quot;</span><span class="p">))</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>                        <span class="n">evRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.actualBatteryCapacity&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">mWh</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1">#  otherwise just a guesstimate</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                        <span class="n">evRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.actualBatteryCapacity&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyKmPerWh</span><span class="p">()</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>                <span class="n">proximity</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>                <span class="n">urgency</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>            <span class="c1"># We have a weight so need to calculate proximity</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>                    <span class="n">neighbours</span><span class="p">,</span> <span class="n">meanDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNeighboursNeedingCharge</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">firstCall</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>                    <span class="n">firstCall</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>                    <span class="c1"># find distance for nearest drone to this eV - usually only one drone so will be the one allocated</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>                    <span class="n">droneDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span>    <span class="c1"># default - should never happen - otherwise fn wouldn&#39;t be called</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>                        <span class="n">droneDist</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>                        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>                            <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">())</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>                            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">droneDist</span><span class="p">:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                                <span class="n">droneDist</span> <span class="o">=</span> <span class="n">dist</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>                    <span class="c1"># proximity factors - smallest value is most important = &#39;nearest</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                        <span class="n">meanDist</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>   <span class="c1"># set distance  &#39;smaller&#39; the more neighbours there are</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                    <span class="k">del</span> <span class="n">neighbours</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                    <span class="c1"># add in drone distance - ie smallest proximity will have closest drone</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>                    <span class="k">if</span> <span class="n">hubDistance</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                       <span class="n">proximity</span> <span class="o">=</span> <span class="n">droneDist</span> <span class="o">+</span> <span class="n">meanDist</span>  <span class="c1"># + evRange</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>                       <span class="n">proximity</span> <span class="o">=</span> <span class="n">droneDist</span> <span class="o">+</span> <span class="n">meanDist</span>  <span class="c1"># / drivingDistance</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                    <span class="n">urgency</span> <span class="o">=</span> <span class="n">hubDistance</span><span class="o">/</span><span class="n">evRange</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                <span class="n">CEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">proximity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">urgency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                <span class="n">urgencyList</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">CEC</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">urgencyList</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="nf">findEdgePos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evID</span><span class="p">,</span> <span class="n">deltaPos</span><span class="p">):</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;work out the edge and position of the EV, when it is deltaPos metres along the route from the current position</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">            to give us an approximation to the rendezvous position</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">jnDelta</span> <span class="o">=</span> <span class="mi">150</span>          <span class="c1"># no of travel metres &#39;lost&#39; by vehicle crossing a junction, found by testing against random grid  (ie allowance for vehicle slowing/accelerating)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="c1"># find route and position of vehicle along the route - (this will always give us an edge)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="n">evRoute</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRoute</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRouteIndex</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">lanePosition</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getLanePosition</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">if</span> <span class="n">deltaPos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;oops invalid call to findEdgePos:&quot;</span><span class="p">,</span> <span class="n">deltaPos</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>            <span class="n">deltaPos</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="c1"># whilst we have the edge from above the vehicle could actually be on a junction which messes up the edge to edge calculation</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="c1"># so we get current road ID which can be a junction and if it is then skip along the route to the next edge</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="n">road</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRoadID</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">road</span> <span class="o">!=</span> <span class="n">edge</span><span class="p">:</span>       <span class="c1"># ev is on a junction, set to start of next edge</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>          <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>          <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>          <span class="n">lanePosition</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="c1"># &#39;travel&#39; along edges on route until we&#39;ve gone  deltaPos metres</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="n">newEVPosition</span> <span class="o">=</span> <span class="n">lanePosition</span> <span class="o">+</span> <span class="n">deltaPos</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">laneLength</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">lane</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="n">edge</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="k">while</span> <span class="n">newEVPosition</span> <span class="o">&gt;</span> <span class="n">laneLength</span> <span class="o">+</span> <span class="n">jnDelta</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="n">newEVPosition</span> <span class="o">-=</span> <span class="p">(</span><span class="n">laneLength</span> <span class="o">+</span> <span class="n">jnDelta</span><span class="p">)</span>    <span class="c1"># subtract jnDelta as the penalty in distance travelled, in the total travel time, for each junction</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evRoute</span><span class="p">):</span>                 <span class="c1"># rv point is after end of route - so we can&#39;t charge</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                <span class="k">return</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">laneLength</span><span class="p">,</span> <span class="kc">False</span>   <span class="c1"># set to end of route</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="n">laneLength</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">lane</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="n">edge</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="n">newEVPosition</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newEVPosition</span><span class="p">,</span> <span class="n">laneLength</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="k">return</span> <span class="n">edge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="k">def</span> <span class="nf">findRendezvousXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">drone</span><span class="p">):</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;estimate a direct rendezvous point for the drone/vehicle - assumes constant vehicle speed</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">              apply a factor of 90% to allow for acceleration/deceleration/% of time not at allowed speed</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">           algorithm from https://www.codeproject.com/Articles/990452/Interception-of-Two-Moving-Objects-in-D-Space</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="n">evID</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>         <span class="c1"># needed for Traci calls</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="c1"># assume speed on current edge is that for subsequent edges</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="n">evSpeed</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getAllowedSpeed</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="c1"># work out how long it takes drone to fly to ev</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="n">posEV</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="n">posDrone</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="n">distanceToEV</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">posDrone</span><span class="p">,</span> <span class="n">posEV</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="n">crowFlies</span> <span class="o">=</span> <span class="n">distanceToEV</span><span class="o">/</span><span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneMperSec</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="c1"># how far vehicle can travel in same time</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="n">evCrowFlies</span> <span class="o">=</span> <span class="n">evSpeed</span> <span class="o">*</span> <span class="n">crowFlies</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="c1"># where on the road that distance is</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="n">vEdge</span><span class="p">,</span> <span class="n">vPos</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findEdgePos</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="n">evCrowFlies</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">posRV</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">convert2D</span><span class="p">(</span><span class="n">vEdge</span><span class="p">,</span> <span class="n">vPos</span><span class="p">)</span>        <span class="c1"># get the x, y position after evCrowFlies metres</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="c1"># compute the velocity vector</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="n">evV</span> <span class="o">=</span> <span class="p">(</span><span class="n">posRV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">crowFlies</span><span class="p">,</span> <span class="p">(</span><span class="n">posRV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">crowFlies</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">vectorFromEV</span> <span class="o">=</span> <span class="n">posDrone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posDrone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneMperSec</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">pow</span><span class="p">(</span><span class="n">evSpeed</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vectorFromEV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">evV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vectorFromEV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">evV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">distanceToEV</span> <span class="o">*</span> <span class="n">distanceToEV</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="n">bb4ac</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bb4ac</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bb4ac</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="n">t1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># no solution we can&#39;t meet the EV</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="k">return</span> <span class="n">posDrone</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="k">if</span> <span class="n">t1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># both positive take the smallest</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="n">interceptDistance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">evSpeed</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># one is -ve so take the maximum</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="n">interceptDistance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">evSpeed</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="n">rendezvousEdge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findEdgePos</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="n">interceptDistance</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>       <span class="c1"># will normally only fail if drone cannot reach EV under straight line intercept assumptions</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="n">posRV</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">convert2D</span><span class="p">(</span><span class="n">rendezvousEdge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">)</span>      <span class="c1"># get the x, y position after evCrowFlies metres</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                <span class="c1"># Algorithm debug lines - show rendezvous point</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="c1"># pid = ev + &quot; &quot; + str(timeStep)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="c1"># traci.poi.add(pid, posRV[0], posRV[1], color=(255, 0, 255), layer=250, imgFile=&quot;.\\PNG132.bmp&quot;, width=5, height=5)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="k">return</span> <span class="n">posRV</span>   <span class="c1"># this falls back to the original crow flies when straight line intercept fails</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="c1"># print(timeStep, ev, drone, evCrowFlies, &quot;fail 2&quot;)  &#39;fail&#39; usually because vehicle has left simulation</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">return</span> <span class="n">posDrone</span>   <span class="c1"># revert to direct intercept</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>    <span class="k">def</span> <span class="nf">getNeighboursNeedingCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">firstCall</span><span class="p">):</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;find all the ev&#39;s that are requesting a charge and compute the mean distance to these</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">              note calling math.dist which will use sqrt is actually faster than comparing distances to the square</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">              we only update the ev positions on first call because we will repeat call to this fn for each ev in creating urgency list</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="n">meanDist</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">nEV</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="k">if</span> <span class="n">nEV</span> <span class="o">==</span> <span class="n">ev</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="k">continue</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                    <span class="n">nEV</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="n">vPos</span> <span class="o">=</span> <span class="n">nEV</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="n">xdist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">vPos</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                <span class="k">if</span> <span class="n">xdist</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                    <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nEV</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                    <span class="n">meanDist</span> <span class="o">+=</span> <span class="n">xdist</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="k">except</span> <span class="n">traci</span><span class="o">.</span><span class="n">TraCIException</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;neighbour exception:&quot;</span><span class="p">,</span> <span class="n">traci</span><span class="o">.</span><span class="n">TraCIException</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                <span class="k">continue</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="n">meanDist</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>                      <span class="c1"># we have at least 1 ev so calculate the actual mean distance</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="n">meanDist</span> <span class="o">=</span> <span class="n">meanDist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">meanDist</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>    <span class="k">def</span> <span class="nf">notifyDroneState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drone</span><span class="p">):</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Notification from Drone when charging finished or Drone has broken off the charge/flight&quot;&quot;&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]]</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">viable</span><span class="p">():</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            <span class="k">if</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="k">def</span> <span class="nf">notifyEVState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">evState</span><span class="p">,</span> <span class="n">drone</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Notification from EV - when EV has left simulation (or completed charge)&quot;&quot;&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">charge</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">match</span> <span class="n">evState</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">DRIVING</span><span class="p">:</span>            <span class="c1"># means charge complete  so calculate charge</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                    <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEREQUESTED</span><span class="p">:</span>    <span class="c1"># just log request</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="k">pass</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEBROKENOFF</span><span class="p">:</span>    <span class="c1"># drone broke off charge so should have an entry in self.startChargeEV</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                    <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGINGFROMDRONE</span><span class="p">:</span>      <span class="c1"># charge started</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">LEFTSIMULATION</span><span class="p">:</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                        <span class="k">if</span> <span class="n">drone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                            <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                            <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                <span class="k">if</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                <span class="k">elif</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]]</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">WAITINGFORRENDEZVOUS</span><span class="p">:</span>   <span class="c1"># don&#39;t see this yet</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="s2">&quot;rv&quot;</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">WAITINGFORDRONE</span><span class="p">:</span>        <span class="c1"># don&#39;t see this</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="s2">&quot;wd&quot;</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">chargePrint</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="n">droneID</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="k">if</span> <span class="n">drone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="n">droneID</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="n">evState</span><span class="p">,</span> <span class="n">droneID</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">charge</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">GG</span><span class="o">.</span><span class="n">chargeLog</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>    <span class="k">def</span> <span class="nf">printDroneStatistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brief</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Print out Drone and EV statistics for the complete run&quot;&quot;&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="c1"># compute drone statistic totals</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="n">tmyFlyingCount</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># used to compute distance travelled</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="n">tmyFullCharges</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># count of complete charges</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="n">tmyBrokenCharges</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># count of charges broken off - either by me out of charge</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="n">tmyBrokenEVCharges</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># count of charges broken off - by EV leaving</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="n">tmyFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>           <span class="c1"># wH i&#39;ve used flying</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="n">tmyChargingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>         <span class="c1"># wH i&#39;ve used charging EVs</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="n">tmyChargeMeFlyingCount</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># wh i&#39;ve charged my flying battery</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">tmyChargeMeCount</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># wh i&#39;ve used charging my EV charging battery</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="n">tmyResidualChargeKWh</span> <span class="o">=</span> <span class="mf">0.0</span>   <span class="c1"># Wh left in charge battery at end</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">tmyResidualFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>   <span class="c1"># Wh left in flying battery at end</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="n">tmyChaseCount</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># no of successful chases  (ie successfully got from rendezvous to EV)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="n">tmyBrokenChaseCount</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c1"># no of broken chases  (vehicle left after rendezvous but before drone got there)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="n">tmyChaseSteps</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># steps for succesful chases - used to compute average chase time</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="n">tDroneDistance</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="n">tmyChargeMeFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="n">tmyChargeMeKWh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">):</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="n">tmyFlyingCount</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="n">tmyFlyingKWh</span>            <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneFlyingWhperTimeStep</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>            <span class="n">tDroneDistance</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneStepMperTimeStep</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">tmyFullCharges</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFullCharges</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="n">tmyBrokenCharges</span>        <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenCharges</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="n">tmyBrokenEVCharges</span>      <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenEVCharges</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="n">tmyChargingKWh</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myEVChargingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="n">tmyChargeMeFlyingCount</span>  <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeFlyingCount</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="n">tmyChargeMeFlyingKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhDroneRechargePerTimeStep</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="n">tmyChargeMeCount</span>        <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeCount</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="n">tmyChargeMeKWh</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhDroneRechargePerTimeStep</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="n">tmyResidualFlyingKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCharge</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="n">tmyResidualChargeKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myCharge</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                <span class="n">tmyChaseCount</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChaseCount</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="n">tmyBrokenChaseCount</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenChaseCount</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="n">tmyChaseSteps</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChaseSteps</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="c1"># alternative computation - avoiding errors from addition of large no of floating point</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="c1"># tmyFlyingKWh = tmyFlyingCount * Drone.droneFlyingWhperTimeStep / 1000.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="n">tDroneDistance</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">tmyFlyingKWh</span>          <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="n">tmyChargingKWh</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">tmyChargeMeFlyingKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">tmyChargeMeKWh</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">tmyResidualFlyingKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">tmyResidualChargeKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="c1"># note chases + broken chases usually less than charge sessions total because some will break off before they get to rendezvous</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="c1"># ie chases are between rendezvous point and beginning charging - indicator of efficiency of rendezvous algorithm</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="k">if</span> <span class="n">tmyChaseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="n">averageChase</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmyChaseSteps</span> <span class="o">*</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">stepSecs</span><span class="p">)</span><span class="o">/</span><span class="n">tmyChaseCount</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                <span class="n">averageChase</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="c1"># all done, dump the distance travelled by the drones and KW used</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1">#  tidy up after the ....</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>        <span class="k">if</span> <span class="n">brief</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="n">sumoVersion</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="n">runstring</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Date</span><span class="se">\t</span><span class="s2">Rv</span><span class="se">\t</span><span class="s2">Once</span><span class="se">\t</span><span class="s2">Output</span><span class="se">\t</span><span class="s2">wE</span><span class="se">\t</span><span class="s2">wU</span><span class="se">\t</span><span class="s2">radius</span><span class="se">\t</span><span class="s2">Steps</span><span class="se">\t</span><span class="s2"># Drones&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                  <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Distance</span><span class="se">\t</span><span class="s2">FlyKWh</span><span class="se">\t</span><span class="s2">chKWh</span><span class="se">\t</span><span class="s2">FlyChgKWh</span><span class="se">\t</span><span class="s2">ChgKWh</span><span class="se">\t</span><span class="s2">rFlyKWh</span><span class="se">\t</span><span class="s2">rChKWh&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                  <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"># EVs</span><span class="se">\t</span><span class="s2">EVChg</span><span class="se">\t</span><span class="s2">EVgap</span><span class="se">\t</span><span class="s2">Full</span><span class="se">\t</span><span class="s2">brDrone</span><span class="se">\t</span><span class="s2">brEV</span><span class="se">\t</span><span class="s2">Chases</span><span class="se">\t</span><span class="s2">Avg Chase</span><span class="se">\t</span><span class="s2">Brk Chase&quot;</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                  <span class="p">(</span><span class="n">timeStamp</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">onlyChargeOnce</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                   <span class="n">GG</span><span class="o">.</span><span class="n">dronePrint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span><span class="p">,</span> <span class="n">tDroneDistance</span><span class="p">,</span> <span class="n">tmyFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargingKWh</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                  <span class="p">(</span><span class="n">tmyChargeMeFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargeMeKWh</span><span class="p">,</span> <span class="n">tmyResidualFlyingKWh</span><span class="p">,</span> <span class="n">tmyResidualChargeKWh</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                  <span class="p">(</span><span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeSteps</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeGap</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmyFullCharges</span><span class="p">,</span> <span class="n">tmyBrokenCharges</span><span class="p">,</span> <span class="n">tmyBrokenEVCharges</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmyChaseCount</span><span class="p">,</span> <span class="n">averageChase</span><span class="p">,</span> <span class="n">tmyBrokenChaseCount</span><span class="p">,</span> <span class="n">runstring</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">sumoVersion</span><span class="p">))</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runstring</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">sumoVersion</span><span class="p">))</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary Statistics:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timeStamp</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Model flags:</span><span class="se">\t</span><span class="s2">Rendezvous: </span><span class="si">{!r}</span><span class="se">\t</span><span class="s2">Charge Once: </span><span class="si">{!r}</span><span class="se">\t</span><span class="s2">Drone print: </span><span class="si">{!r}</span><span class="se">\n\t</span><span class="s2">Energy Weight: &quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                  <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="s2">Urgency Weight: </span><span class="si">{:.1f}</span><span class="se">\t</span><span class="s2">Proximity radius(m): </span><span class="si">{:.0f}</span><span class="se">\t</span><span class="s2">Time steps: </span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                  <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">onlyChargeOnce</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">dronePrint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">,</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                   <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">))</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Drone Totals:</span><span class="se">\t</span><span class="s2">(</span><span class="si">%i</span><span class="s2"> drones)</span><span class="se">\n\t\t</span><span class="s2">Distance Km:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n\t\t</span><span class="s2">Charging KWh:</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span><span class="p">,</span> <span class="n">tDroneDistance</span><span class="p">,</span> <span class="n">tmyFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargingKWh</span><span class="p">))</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Drone Charger usage:</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\n\t\t</span><span class="s2">Charge KWh:</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                  <span class="p">(</span><span class="n">tmyChargeMeFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargeMeKWh</span><span class="p">))</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Residuals:</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\n\t\t</span><span class="s2">Charging KWh:</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                  <span class="p">(</span><span class="n">tmyResidualFlyingKWh</span><span class="p">,</span> <span class="n">tmyResidualChargeKWh</span><span class="p">))</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">EV Totals:</span><span class="se">\t</span><span class="s2">(</span><span class="si">%i</span><span class="s2"> EVs)</span><span class="se">\n\t\t</span><span class="s2">Charge KWh:</span><span class="se">\t</span><span class="si">%.1f</span><span class="se">\n\t\t</span><span class="s2">Charge Gap KWh:</span><span class="se">\t</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                  <span class="p">(</span><span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeSteps</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeGap</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">)))</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Charge Sessions:</span><span class="se">\n\t\t\t</span><span class="s2">Full charges:</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\n\t\t\t</span><span class="s2">Part (drone):</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\n\t\t\t</span><span class="s2">Part (ev):</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                  <span class="p">(</span><span class="n">tmyFullCharges</span><span class="p">,</span> <span class="n">tmyBrokenCharges</span><span class="p">,</span> <span class="n">tmyBrokenEVCharges</span><span class="p">))</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Successful chases: </span><span class="si">%i</span><span class="se">\t</span><span class="s2">Average chase time: </span><span class="si">%.1f</span><span class="s2">s</span><span class="se">\t</span><span class="s2">broken Chases: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                      <span class="p">(</span><span class="n">tmyChaseCount</span><span class="p">,</span> <span class="n">averageChase</span><span class="p">,</span> <span class="n">tmyBrokenChaseCount</span><span class="p">))</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Discrete Drone data:&quot;</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">)):</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                <span class="n">droneDistance</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneStepMperTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                <span class="n">droneFlyingKWh</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneFlyingWhperTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                <span class="n">droneChargeKWh</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myEVChargingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">drone:</span><span class="si">{}</span><span class="se">\t</span><span class="s2">Km:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">Charge KW:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">FlyingKW:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">Residual (chargeWh:</span><span class="si">{:.0f}</span><span class="s2"> flyingWh:</span><span class="si">{:.0f}</span><span class="s2">)&quot;</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">droneDistance</span><span class="p">,</span> <span class="n">droneChargeKWh</span><span class="p">,</span> <span class="n">droneFlyingKWh</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">myCharge</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCharge</span><span class="p">))</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>    <span class="k">def</span> <span class="nf">requestCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">requestedWh</span><span class="o">=</span><span class="mf">2000.</span><span class="p">):</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;request for charge from EV&quot;&quot;&quot;</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestedWh</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">chargePrint</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEREQUESTED</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">requestedWh</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">GG</span><span class="o">.</span><span class="n">chargeLog</span><span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>    <span class="k">def</span> <span class="nf">setMaxDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmaxDrones</span><span class="p">):</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; update maxDrones - when --z option is used drones are limited to those in the add file&quot;&quot;&quot;</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">=</span> <span class="n">pmaxDrones</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">syncSpawnedDrones</span><span class="p">()</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>    <span class="k">def</span> <span class="nf">syncSpawnedDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;if we&#39;ve generated drones from POI definitions in the add file we need to update our spawnedDrone count&quot;&quot;&quot;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">=</span> <span class="n">Drone</span><span class="o">.</span><span class="n">getIDCount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">tidyDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;remove any dummy vehicles left after all vehicles have left - ie simulation has finished&quot;&quot;&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertedDummies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDummyEVInserted</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                    <span class="n">drone</span><span class="o">.</span><span class="n">dummyEVHide</span><span class="p">()</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Management of &#39;control centre&#39; executed by simulation on every step&quot;&quot;&quot;</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="n">availableDrones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="n">availableDrones</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="n">urgencyList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcUrgency</span><span class="p">()</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">allocateDrones</span><span class="p">(</span><span class="n">urgencyList</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="k">del</span> <span class="n">urgencyList</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="c1"># Control centre manages parking/charging of drones</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="c1"># each EV &#39;manages&#39; the drone allocated to them</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="n">drone</span><span class="o">.</span><span class="n">parkingUpdate</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="ControlCentre">
                            <input id="ControlCentre-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ControlCentre</span>:

                <label class="view-source-button" for="ControlCentre-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre-12"><a href="#ControlCentre-12"><span class="linenos"> 12</span></a><span class="k">class</span> <span class="nc">ControlCentre</span><span class="p">:</span>
</span><span id="ControlCentre-13"><a href="#ControlCentre-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class receiving requests from EV&#39;s and notifications from Drones and EV&#39;s when charge completes or Drone is out of battery&quot;&quot;&quot;</span>
</span><span id="ControlCentre-14"><a href="#ControlCentre-14"><span class="linenos"> 14</span></a>
</span><span id="ControlCentre-15"><a href="#ControlCentre-15"><span class="linenos"> 15</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wEnergy</span><span class="p">,</span> <span class="n">wUrgency</span><span class="p">,</span> <span class="n">proximityRadius</span><span class="p">,</span> <span class="n">maxDrones</span><span class="p">,</span> <span class="n">droneType</span><span class="o">=</span><span class="s2">&quot;ehang184&quot;</span><span class="p">):</span>
</span><span id="ControlCentre-16"><a href="#ControlCentre-16"><span class="linenos"> 16</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wEnergy</span><span class="p">)</span>
</span><span id="ControlCentre-17"><a href="#ControlCentre-17"><span class="linenos"> 17</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wUrgency</span><span class="p">)</span>
</span><span id="ControlCentre-18"><a href="#ControlCentre-18"><span class="linenos"> 18</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span> <span class="o">=</span> <span class="n">proximityRadius</span>
</span><span id="ControlCentre-19"><a href="#ControlCentre-19"><span class="linenos"> 19</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">=</span> <span class="n">maxDrones</span>
</span><span id="ControlCentre-20"><a href="#ControlCentre-20"><span class="linenos"> 20</span></a>
</span><span id="ControlCentre-21"><a href="#ControlCentre-21"><span class="linenos"> 21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre-22"><a href="#ControlCentre-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre-23"><a href="#ControlCentre-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre-24"><a href="#ControlCentre-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre-25"><a href="#ControlCentre-25"><span class="linenos"> 25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ControlCentre-26"><a href="#ControlCentre-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ControlCentre-27"><a href="#ControlCentre-27"><span class="linenos"> 27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">droneType</span> <span class="o">=</span> <span class="n">droneType</span>
</span><span id="ControlCentre-28"><a href="#ControlCentre-28"><span class="linenos"> 28</span></a>
</span><span id="ControlCentre-29"><a href="#ControlCentre-29"><span class="linenos"> 29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre-30"><a href="#ControlCentre-30"><span class="linenos"> 30</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">insertedDummies</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre-31"><a href="#ControlCentre-31"><span class="linenos"> 31</span></a>
</span><span id="ControlCentre-32"><a href="#ControlCentre-32"><span class="linenos"> 32</span></a>
</span><span id="ControlCentre-33"><a href="#ControlCentre-33"><span class="linenos"> 33</span></a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
</span><span id="ControlCentre-34"><a href="#ControlCentre-34"><span class="linenos"> 34</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the mapping between drone and ev&quot;&quot;&quot;</span>
</span><span id="ControlCentre-35"><a href="#ControlCentre-35"><span class="linenos"> 35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">drone</span>
</span><span id="ControlCentre-36"><a href="#ControlCentre-36"><span class="linenos"> 36</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span>
</span><span id="ControlCentre-37"><a href="#ControlCentre-37"><span class="linenos"> 37</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre-38"><a href="#ControlCentre-38"><span class="linenos"> 38</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">findRendezvousXY</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">drone</span><span class="p">))</span>
</span><span id="ControlCentre-39"><a href="#ControlCentre-39"><span class="linenos"> 39</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-40"><a href="#ControlCentre-40"><span class="linenos"> 40</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre-41"><a href="#ControlCentre-41"><span class="linenos"> 41</span></a>        <span class="n">requestedWh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre-42"><a href="#ControlCentre-42"><span class="linenos"> 42</span></a>        <span class="n">drone</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">requestedWh</span><span class="p">)</span>
</span><span id="ControlCentre-43"><a href="#ControlCentre-43"><span class="linenos"> 43</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre-44"><a href="#ControlCentre-44"><span class="linenos"> 44</span></a>        <span class="c1">#print(&quot;allocation&quot;, GG.ss.timeStep, drone.getID(), ev.getID())</span>
</span><span id="ControlCentre-45"><a href="#ControlCentre-45"><span class="linenos"> 45</span></a>
</span><span id="ControlCentre-46"><a href="#ControlCentre-46"><span class="linenos"> 46</span></a>    <span class="k">def</span> <span class="nf">allocateDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urgencyList</span><span class="p">):</span>
</span><span id="ControlCentre-47"><a href="#ControlCentre-47"><span class="linenos"> 47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate whatever drones we have free/viable in order of urgency,</span>
</span><span id="ControlCentre-48"><a href="#ControlCentre-48"><span class="linenos"> 48</span></a><span class="sd">            if more than one drone available assign the nearest&quot;&quot;&quot;</span>
</span><span id="ControlCentre-49"><a href="#ControlCentre-49"><span class="linenos"> 49</span></a>        <span class="n">ld</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span>
</span><span id="ControlCentre-50"><a href="#ControlCentre-50"><span class="linenos"> 50</span></a>        <span class="n">nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span>
</span><span id="ControlCentre-51"><a href="#ControlCentre-51"><span class="linenos"> 51</span></a>        <span class="k">if</span> <span class="n">ld</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ControlCentre-52"><a href="#ControlCentre-52"><span class="linenos"> 52</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre-53"><a href="#ControlCentre-53"><span class="linenos"> 53</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre-54"><a href="#ControlCentre-54"><span class="linenos"> 54</span></a>                <span class="k">break</span>
</span><span id="ControlCentre-55"><a href="#ControlCentre-55"><span class="linenos"> 55</span></a>        <span class="k">elif</span> <span class="n">ld</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-56"><a href="#ControlCentre-56"><span class="linenos"> 56</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre-57"><a href="#ControlCentre-57"><span class="linenos"> 57</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-58"><a href="#ControlCentre-58"><span class="linenos"> 58</span></a>                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="ControlCentre-59"><a href="#ControlCentre-59"><span class="linenos"> 59</span></a>                <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre-60"><a href="#ControlCentre-60"><span class="linenos"> 60</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre-61"><a href="#ControlCentre-61"><span class="linenos"> 61</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre-62"><a href="#ControlCentre-62"><span class="linenos"> 62</span></a>                <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="ControlCentre-63"><a href="#ControlCentre-63"><span class="linenos"> 63</span></a>                <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-64"><a href="#ControlCentre-64"><span class="linenos"> 64</span></a>                    <span class="k">break</span>
</span><span id="ControlCentre-65"><a href="#ControlCentre-65"><span class="linenos"> 65</span></a>
</span><span id="ControlCentre-66"><a href="#ControlCentre-66"><span class="linenos"> 66</span></a>        <span class="k">elif</span> <span class="n">ld</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># need to find drone nearest the ev before we allocate</span>
</span><span id="ControlCentre-67"><a href="#ControlCentre-67"><span class="linenos"> 67</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre-68"><a href="#ControlCentre-68"><span class="linenos"> 68</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-69"><a href="#ControlCentre-69"><span class="linenos"> 69</span></a>                <span class="n">nearestDrone</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ControlCentre-70"><a href="#ControlCentre-70"><span class="linenos"> 70</span></a>                <span class="n">evDistance</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
</span><span id="ControlCentre-71"><a href="#ControlCentre-71"><span class="linenos"> 71</span></a>                <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">:</span>
</span><span id="ControlCentre-72"><a href="#ControlCentre-72"><span class="linenos"> 72</span></a>                    <span class="n">dronePos</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-73"><a href="#ControlCentre-73"><span class="linenos"> 73</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">dronePos</span><span class="p">)</span>
</span><span id="ControlCentre-74"><a href="#ControlCentre-74"><span class="linenos"> 74</span></a>                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">evDistance</span><span class="p">:</span>
</span><span id="ControlCentre-75"><a href="#ControlCentre-75"><span class="linenos"> 75</span></a>                        <span class="n">nearestDrone</span> <span class="o">=</span> <span class="n">drone</span>
</span><span id="ControlCentre-76"><a href="#ControlCentre-76"><span class="linenos"> 76</span></a>                        <span class="n">evDistance</span> <span class="o">=</span> <span class="n">distance</span>
</span><span id="ControlCentre-77"><a href="#ControlCentre-77"><span class="linenos"> 77</span></a>                <span class="k">if</span> <span class="n">nearestDrone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ControlCentre-78"><a href="#ControlCentre-78"><span class="linenos"> 78</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">nearestDrone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre-79"><a href="#ControlCentre-79"><span class="linenos"> 79</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nearestDrone</span><span class="p">)</span>
</span><span id="ControlCentre-80"><a href="#ControlCentre-80"><span class="linenos"> 80</span></a>                <span class="k">elif</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-81"><a href="#ControlCentre-81"><span class="linenos"> 81</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="ControlCentre-82"><a href="#ControlCentre-82"><span class="linenos"> 82</span></a>                    <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre-83"><a href="#ControlCentre-83"><span class="linenos"> 83</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre-84"><a href="#ControlCentre-84"><span class="linenos"> 84</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre-85"><a href="#ControlCentre-85"><span class="linenos"> 85</span></a>                    <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="ControlCentre-86"><a href="#ControlCentre-86"><span class="linenos"> 86</span></a>                    <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-87"><a href="#ControlCentre-87"><span class="linenos"> 87</span></a>                        <span class="k">break</span>
</span><span id="ControlCentre-88"><a href="#ControlCentre-88"><span class="linenos"> 88</span></a>
</span><span id="ControlCentre-89"><a href="#ControlCentre-89"><span class="linenos"> 89</span></a>        <span class="k">else</span><span class="p">:</span>   <span class="c1"># ld == 0 nd &gt;0</span>
</span><span id="ControlCentre-90"><a href="#ControlCentre-90"><span class="linenos"> 90</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre-91"><a href="#ControlCentre-91"><span class="linenos"> 91</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-92"><a href="#ControlCentre-92"><span class="linenos"> 92</span></a>                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="ControlCentre-93"><a href="#ControlCentre-93"><span class="linenos"> 93</span></a>                <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre-94"><a href="#ControlCentre-94"><span class="linenos"> 94</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre-95"><a href="#ControlCentre-95"><span class="linenos"> 95</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre-96"><a href="#ControlCentre-96"><span class="linenos"> 96</span></a>                <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="ControlCentre-97"><a href="#ControlCentre-97"><span class="linenos"> 97</span></a>                <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-98"><a href="#ControlCentre-98"><span class="linenos"> 98</span></a>                    <span class="k">break</span>
</span><span id="ControlCentre-99"><a href="#ControlCentre-99"><span class="linenos"> 99</span></a>
</span><span id="ControlCentre-100"><a href="#ControlCentre-100"><span class="linenos">100</span></a>    <span class="k">def</span> <span class="nf">calcUrgency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre-101"><a href="#ControlCentre-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;urgency defined as distance to nearest hub/distance ev can travel on charge.</span>
</span><span id="ControlCentre-102"><a href="#ControlCentre-102"><span class="linenos">102</span></a><span class="sd">            creates a list of ev&#39;s that want charge, have not been allocated a drone</span>
</span><span id="ControlCentre-103"><a href="#ControlCentre-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre-104"><a href="#ControlCentre-104"><span class="linenos">104</span></a>        <span class="n">urgencyList</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre-105"><a href="#ControlCentre-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ControlCentre-106"><a href="#ControlCentre-106"><span class="linenos">106</span></a>          <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre-107"><a href="#ControlCentre-107"><span class="linenos">107</span></a>            <span class="n">urgencyList</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ControlCentre-108"><a href="#ControlCentre-108"><span class="linenos">108</span></a>
</span><span id="ControlCentre-109"><a href="#ControlCentre-109"><span class="linenos">109</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-110"><a href="#ControlCentre-110"><span class="linenos">110</span></a>            <span class="n">firstCall</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ControlCentre-111"><a href="#ControlCentre-111"><span class="linenos">111</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre-112"><a href="#ControlCentre-112"><span class="linenos">112</span></a>                <span class="c1"># note drivingDistance can be very large -  float max if there is no hub on the remaining route</span>
</span><span id="ControlCentre-113"><a href="#ControlCentre-113"><span class="linenos">113</span></a>                <span class="n">evID</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
</span><span id="ControlCentre-114"><a href="#ControlCentre-114"><span class="linenos">114</span></a>                <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="ControlCentre-115"><a href="#ControlCentre-115"><span class="linenos">115</span></a>                    <span class="n">ev</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-116"><a href="#ControlCentre-116"><span class="linenos">116</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-117"><a href="#ControlCentre-117"><span class="linenos">117</span></a>
</span><span id="ControlCentre-118"><a href="#ControlCentre-118"><span class="linenos">118</span></a>                <span class="n">hub</span><span class="p">,</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">findNearestHub</span><span class="p">(</span><span class="n">evPos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evPos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ControlCentre-119"><a href="#ControlCentre-119"><span class="linenos">119</span></a>                <span class="c1"># hub, hubDistance = GG.ch.findNearestHubDriving(evID)</span>
</span><span id="ControlCentre-120"><a href="#ControlCentre-120"><span class="linenos">120</span></a>                <span class="n">evRange</span> <span class="o">=</span> <span class="mf">200.0</span>
</span><span id="ControlCentre-121"><a href="#ControlCentre-121"><span class="linenos">121</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># if we have an ugency weight then we need to calculate the range</span>
</span><span id="ControlCentre-122"><a href="#ControlCentre-122"><span class="linenos">122</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getDistance</span><span class="p">(</span><span class="n">evID</span><span class="p">))</span>
</span><span id="ControlCentre-123"><a href="#ControlCentre-123"><span class="linenos">123</span></a>                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>  <span class="c1"># can compute real range after we&#39;ve been driving for a while - arbitrary 10km</span>
</span><span id="ControlCentre-124"><a href="#ControlCentre-124"><span class="linenos">124</span></a>                        <span class="n">mWh</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.totalEnergyConsumed&quot;</span><span class="p">))</span>
</span><span id="ControlCentre-125"><a href="#ControlCentre-125"><span class="linenos">125</span></a>                        <span class="n">evRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.actualBatteryCapacity&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">mWh</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-126"><a href="#ControlCentre-126"><span class="linenos">126</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1">#  otherwise just a guesstimate</span>
</span><span id="ControlCentre-127"><a href="#ControlCentre-127"><span class="linenos">127</span></a>                        <span class="n">evRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.actualBatteryCapacity&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyKmPerWh</span><span class="p">()</span>
</span><span id="ControlCentre-128"><a href="#ControlCentre-128"><span class="linenos">128</span></a>
</span><span id="ControlCentre-129"><a href="#ControlCentre-129"><span class="linenos">129</span></a>                <span class="n">proximity</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ControlCentre-130"><a href="#ControlCentre-130"><span class="linenos">130</span></a>                <span class="n">urgency</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ControlCentre-131"><a href="#ControlCentre-131"><span class="linenos">131</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>            <span class="c1"># We have a weight so need to calculate proximity</span>
</span><span id="ControlCentre-132"><a href="#ControlCentre-132"><span class="linenos">132</span></a>                    <span class="n">neighbours</span><span class="p">,</span> <span class="n">meanDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNeighboursNeedingCharge</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">firstCall</span><span class="p">)</span>
</span><span id="ControlCentre-133"><a href="#ControlCentre-133"><span class="linenos">133</span></a>                    <span class="n">firstCall</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ControlCentre-134"><a href="#ControlCentre-134"><span class="linenos">134</span></a>
</span><span id="ControlCentre-135"><a href="#ControlCentre-135"><span class="linenos">135</span></a>                    <span class="c1"># find distance for nearest drone to this eV - usually only one drone so will be the one allocated</span>
</span><span id="ControlCentre-136"><a href="#ControlCentre-136"><span class="linenos">136</span></a>                    <span class="n">droneDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span>    <span class="c1"># default - should never happen - otherwise fn wouldn&#39;t be called</span>
</span><span id="ControlCentre-137"><a href="#ControlCentre-137"><span class="linenos">137</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-138"><a href="#ControlCentre-138"><span class="linenos">138</span></a>                        <span class="n">droneDist</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
</span><span id="ControlCentre-139"><a href="#ControlCentre-139"><span class="linenos">139</span></a>                        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">:</span>
</span><span id="ControlCentre-140"><a href="#ControlCentre-140"><span class="linenos">140</span></a>                            <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">())</span>
</span><span id="ControlCentre-141"><a href="#ControlCentre-141"><span class="linenos">141</span></a>                            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">droneDist</span><span class="p">:</span>
</span><span id="ControlCentre-142"><a href="#ControlCentre-142"><span class="linenos">142</span></a>                                <span class="n">droneDist</span> <span class="o">=</span> <span class="n">dist</span>
</span><span id="ControlCentre-143"><a href="#ControlCentre-143"><span class="linenos">143</span></a>
</span><span id="ControlCentre-144"><a href="#ControlCentre-144"><span class="linenos">144</span></a>                    <span class="c1"># proximity factors - smallest value is most important = &#39;nearest</span>
</span><span id="ControlCentre-145"><a href="#ControlCentre-145"><span class="linenos">145</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ControlCentre-146"><a href="#ControlCentre-146"><span class="linenos">146</span></a>                        <span class="n">meanDist</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>   <span class="c1"># set distance  &#39;smaller&#39; the more neighbours there are</span>
</span><span id="ControlCentre-147"><a href="#ControlCentre-147"><span class="linenos">147</span></a>                    <span class="k">del</span> <span class="n">neighbours</span>
</span><span id="ControlCentre-148"><a href="#ControlCentre-148"><span class="linenos">148</span></a>
</span><span id="ControlCentre-149"><a href="#ControlCentre-149"><span class="linenos">149</span></a>                    <span class="c1"># add in drone distance - ie smallest proximity will have closest drone</span>
</span><span id="ControlCentre-150"><a href="#ControlCentre-150"><span class="linenos">150</span></a>                    <span class="k">if</span> <span class="n">hubDistance</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span><span id="ControlCentre-151"><a href="#ControlCentre-151"><span class="linenos">151</span></a>                       <span class="n">proximity</span> <span class="o">=</span> <span class="n">droneDist</span> <span class="o">+</span> <span class="n">meanDist</span>  <span class="c1"># + evRange</span>
</span><span id="ControlCentre-152"><a href="#ControlCentre-152"><span class="linenos">152</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-153"><a href="#ControlCentre-153"><span class="linenos">153</span></a>                       <span class="n">proximity</span> <span class="o">=</span> <span class="n">droneDist</span> <span class="o">+</span> <span class="n">meanDist</span>  <span class="c1"># / drivingDistance</span>
</span><span id="ControlCentre-154"><a href="#ControlCentre-154"><span class="linenos">154</span></a>
</span><span id="ControlCentre-155"><a href="#ControlCentre-155"><span class="linenos">155</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-156"><a href="#ControlCentre-156"><span class="linenos">156</span></a>                    <span class="n">urgency</span> <span class="o">=</span> <span class="n">hubDistance</span><span class="o">/</span><span class="n">evRange</span>
</span><span id="ControlCentre-157"><a href="#ControlCentre-157"><span class="linenos">157</span></a>
</span><span id="ControlCentre-158"><a href="#ControlCentre-158"><span class="linenos">158</span></a>                <span class="n">CEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">proximity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">urgency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">)</span>
</span><span id="ControlCentre-159"><a href="#ControlCentre-159"><span class="linenos">159</span></a>                <span class="n">urgencyList</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">CEC</span>
</span><span id="ControlCentre-160"><a href="#ControlCentre-160"><span class="linenos">160</span></a>
</span><span id="ControlCentre-161"><a href="#ControlCentre-161"><span class="linenos">161</span></a>        <span class="k">return</span> <span class="n">urgencyList</span>
</span><span id="ControlCentre-162"><a href="#ControlCentre-162"><span class="linenos">162</span></a>
</span><span id="ControlCentre-163"><a href="#ControlCentre-163"><span class="linenos">163</span></a>    <span class="k">def</span> <span class="nf">findEdgePos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evID</span><span class="p">,</span> <span class="n">deltaPos</span><span class="p">):</span>
</span><span id="ControlCentre-164"><a href="#ControlCentre-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;work out the edge and position of the EV, when it is deltaPos metres along the route from the current position</span>
</span><span id="ControlCentre-165"><a href="#ControlCentre-165"><span class="linenos">165</span></a><span class="sd">            to give us an approximation to the rendezvous position</span>
</span><span id="ControlCentre-166"><a href="#ControlCentre-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre-167"><a href="#ControlCentre-167"><span class="linenos">167</span></a>        <span class="n">jnDelta</span> <span class="o">=</span> <span class="mi">150</span>          <span class="c1"># no of travel metres &#39;lost&#39; by vehicle crossing a junction, found by testing against random grid  (ie allowance for vehicle slowing/accelerating)</span>
</span><span id="ControlCentre-168"><a href="#ControlCentre-168"><span class="linenos">168</span></a>        <span class="c1"># find route and position of vehicle along the route - (this will always give us an edge)</span>
</span><span id="ControlCentre-169"><a href="#ControlCentre-169"><span class="linenos">169</span></a>        <span class="n">evRoute</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRoute</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre-170"><a href="#ControlCentre-170"><span class="linenos">170</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRouteIndex</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre-171"><a href="#ControlCentre-171"><span class="linenos">171</span></a>        <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ControlCentre-172"><a href="#ControlCentre-172"><span class="linenos">172</span></a>        <span class="n">lanePosition</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getLanePosition</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre-173"><a href="#ControlCentre-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">deltaPos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-174"><a href="#ControlCentre-174"><span class="linenos">174</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;oops invalid call to findEdgePos:&quot;</span><span class="p">,</span> <span class="n">deltaPos</span><span class="p">)</span>
</span><span id="ControlCentre-175"><a href="#ControlCentre-175"><span class="linenos">175</span></a>            <span class="n">deltaPos</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre-176"><a href="#ControlCentre-176"><span class="linenos">176</span></a>        <span class="c1"># whilst we have the edge from above the vehicle could actually be on a junction which messes up the edge to edge calculation</span>
</span><span id="ControlCentre-177"><a href="#ControlCentre-177"><span class="linenos">177</span></a>        <span class="c1"># so we get current road ID which can be a junction and if it is then skip along the route to the next edge</span>
</span><span id="ControlCentre-178"><a href="#ControlCentre-178"><span class="linenos">178</span></a>        <span class="n">road</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRoadID</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre-179"><a href="#ControlCentre-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">road</span> <span class="o">!=</span> <span class="n">edge</span><span class="p">:</span>       <span class="c1"># ev is on a junction, set to start of next edge</span>
</span><span id="ControlCentre-180"><a href="#ControlCentre-180"><span class="linenos">180</span></a>          <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre-181"><a href="#ControlCentre-181"><span class="linenos">181</span></a>          <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ControlCentre-182"><a href="#ControlCentre-182"><span class="linenos">182</span></a>          <span class="n">lanePosition</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre-183"><a href="#ControlCentre-183"><span class="linenos">183</span></a>
</span><span id="ControlCentre-184"><a href="#ControlCentre-184"><span class="linenos">184</span></a>        <span class="c1"># &#39;travel&#39; along edges on route until we&#39;ve gone  deltaPos metres</span>
</span><span id="ControlCentre-185"><a href="#ControlCentre-185"><span class="linenos">185</span></a>        <span class="n">newEVPosition</span> <span class="o">=</span> <span class="n">lanePosition</span> <span class="o">+</span> <span class="n">deltaPos</span>
</span><span id="ControlCentre-186"><a href="#ControlCentre-186"><span class="linenos">186</span></a>        <span class="n">laneLength</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">lane</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="n">edge</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">)</span>
</span><span id="ControlCentre-187"><a href="#ControlCentre-187"><span class="linenos">187</span></a>        <span class="k">while</span> <span class="n">newEVPosition</span> <span class="o">&gt;</span> <span class="n">laneLength</span> <span class="o">+</span> <span class="n">jnDelta</span><span class="p">:</span>
</span><span id="ControlCentre-188"><a href="#ControlCentre-188"><span class="linenos">188</span></a>            <span class="n">newEVPosition</span> <span class="o">-=</span> <span class="p">(</span><span class="n">laneLength</span> <span class="o">+</span> <span class="n">jnDelta</span><span class="p">)</span>    <span class="c1"># subtract jnDelta as the penalty in distance travelled, in the total travel time, for each junction</span>
</span><span id="ControlCentre-189"><a href="#ControlCentre-189"><span class="linenos">189</span></a>            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre-190"><a href="#ControlCentre-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evRoute</span><span class="p">):</span>                 <span class="c1"># rv point is after end of route - so we can&#39;t charge</span>
</span><span id="ControlCentre-191"><a href="#ControlCentre-191"><span class="linenos">191</span></a>                <span class="k">return</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">laneLength</span><span class="p">,</span> <span class="kc">False</span>   <span class="c1"># set to end of route</span>
</span><span id="ControlCentre-192"><a href="#ControlCentre-192"><span class="linenos">192</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ControlCentre-193"><a href="#ControlCentre-193"><span class="linenos">193</span></a>            <span class="n">laneLength</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">lane</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="n">edge</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">)</span>
</span><span id="ControlCentre-194"><a href="#ControlCentre-194"><span class="linenos">194</span></a>
</span><span id="ControlCentre-195"><a href="#ControlCentre-195"><span class="linenos">195</span></a>        <span class="n">newEVPosition</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newEVPosition</span><span class="p">,</span> <span class="n">laneLength</span><span class="p">)</span>
</span><span id="ControlCentre-196"><a href="#ControlCentre-196"><span class="linenos">196</span></a>
</span><span id="ControlCentre-197"><a href="#ControlCentre-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="n">edge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="ControlCentre-198"><a href="#ControlCentre-198"><span class="linenos">198</span></a>
</span><span id="ControlCentre-199"><a href="#ControlCentre-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">findRendezvousXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">drone</span><span class="p">):</span>
</span><span id="ControlCentre-200"><a href="#ControlCentre-200"><span class="linenos">200</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;estimate a direct rendezvous point for the drone/vehicle - assumes constant vehicle speed</span>
</span><span id="ControlCentre-201"><a href="#ControlCentre-201"><span class="linenos">201</span></a><span class="sd">              apply a factor of 90% to allow for acceleration/deceleration/% of time not at allowed speed</span>
</span><span id="ControlCentre-202"><a href="#ControlCentre-202"><span class="linenos">202</span></a><span class="sd">           algorithm from https://www.codeproject.com/Articles/990452/Interception-of-Two-Moving-Objects-in-D-Space</span>
</span><span id="ControlCentre-203"><a href="#ControlCentre-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre-204"><a href="#ControlCentre-204"><span class="linenos">204</span></a>        <span class="n">evID</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>         <span class="c1"># needed for Traci calls</span>
</span><span id="ControlCentre-205"><a href="#ControlCentre-205"><span class="linenos">205</span></a>        <span class="c1"># assume speed on current edge is that for subsequent edges</span>
</span><span id="ControlCentre-206"><a href="#ControlCentre-206"><span class="linenos">206</span></a>        <span class="n">evSpeed</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getAllowedSpeed</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre-207"><a href="#ControlCentre-207"><span class="linenos">207</span></a>
</span><span id="ControlCentre-208"><a href="#ControlCentre-208"><span class="linenos">208</span></a>        <span class="c1"># work out how long it takes drone to fly to ev</span>
</span><span id="ControlCentre-209"><a href="#ControlCentre-209"><span class="linenos">209</span></a>        <span class="n">posEV</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-210"><a href="#ControlCentre-210"><span class="linenos">210</span></a>        <span class="n">posDrone</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-211"><a href="#ControlCentre-211"><span class="linenos">211</span></a>        <span class="n">distanceToEV</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">posDrone</span><span class="p">,</span> <span class="n">posEV</span><span class="p">)</span>
</span><span id="ControlCentre-212"><a href="#ControlCentre-212"><span class="linenos">212</span></a>        <span class="n">crowFlies</span> <span class="o">=</span> <span class="n">distanceToEV</span><span class="o">/</span><span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneMperSec</span>
</span><span id="ControlCentre-213"><a href="#ControlCentre-213"><span class="linenos">213</span></a>        <span class="c1"># how far vehicle can travel in same time</span>
</span><span id="ControlCentre-214"><a href="#ControlCentre-214"><span class="linenos">214</span></a>        <span class="n">evCrowFlies</span> <span class="o">=</span> <span class="n">evSpeed</span> <span class="o">*</span> <span class="n">crowFlies</span>
</span><span id="ControlCentre-215"><a href="#ControlCentre-215"><span class="linenos">215</span></a>        <span class="c1"># where on the road that distance is</span>
</span><span id="ControlCentre-216"><a href="#ControlCentre-216"><span class="linenos">216</span></a>        <span class="n">vEdge</span><span class="p">,</span> <span class="n">vPos</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findEdgePos</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="n">evCrowFlies</span><span class="p">)</span>
</span><span id="ControlCentre-217"><a href="#ControlCentre-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
</span><span id="ControlCentre-218"><a href="#ControlCentre-218"><span class="linenos">218</span></a>            <span class="n">posRV</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">convert2D</span><span class="p">(</span><span class="n">vEdge</span><span class="p">,</span> <span class="n">vPos</span><span class="p">)</span>        <span class="c1"># get the x, y position after evCrowFlies metres</span>
</span><span id="ControlCentre-219"><a href="#ControlCentre-219"><span class="linenos">219</span></a>            <span class="c1"># compute the velocity vector</span>
</span><span id="ControlCentre-220"><a href="#ControlCentre-220"><span class="linenos">220</span></a>            <span class="n">evV</span> <span class="o">=</span> <span class="p">(</span><span class="n">posRV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">crowFlies</span><span class="p">,</span> <span class="p">(</span><span class="n">posRV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">crowFlies</span>
</span><span id="ControlCentre-221"><a href="#ControlCentre-221"><span class="linenos">221</span></a>
</span><span id="ControlCentre-222"><a href="#ControlCentre-222"><span class="linenos">222</span></a>            <span class="n">vectorFromEV</span> <span class="o">=</span> <span class="n">posDrone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posDrone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ControlCentre-223"><a href="#ControlCentre-223"><span class="linenos">223</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneMperSec</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">pow</span><span class="p">(</span><span class="n">evSpeed</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ControlCentre-224"><a href="#ControlCentre-224"><span class="linenos">224</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vectorFromEV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">evV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vectorFromEV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">evV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ControlCentre-225"><a href="#ControlCentre-225"><span class="linenos">225</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">distanceToEV</span> <span class="o">*</span> <span class="n">distanceToEV</span>
</span><span id="ControlCentre-226"><a href="#ControlCentre-226"><span class="linenos">226</span></a>            <span class="n">bb4ac</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
</span><span id="ControlCentre-227"><a href="#ControlCentre-227"><span class="linenos">227</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bb4ac</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="ControlCentre-228"><a href="#ControlCentre-228"><span class="linenos">228</span></a>            <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bb4ac</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="ControlCentre-229"><a href="#ControlCentre-229"><span class="linenos">229</span></a>
</span><span id="ControlCentre-230"><a href="#ControlCentre-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="n">t1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># no solution we can&#39;t meet the EV</span>
</span><span id="ControlCentre-231"><a href="#ControlCentre-231"><span class="linenos">231</span></a>                <span class="k">return</span> <span class="n">posDrone</span>
</span><span id="ControlCentre-232"><a href="#ControlCentre-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">t1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># both positive take the smallest</span>
</span><span id="ControlCentre-233"><a href="#ControlCentre-233"><span class="linenos">233</span></a>                <span class="n">interceptDistance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">evSpeed</span>
</span><span id="ControlCentre-234"><a href="#ControlCentre-234"><span class="linenos">234</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># one is -ve so take the maximum</span>
</span><span id="ControlCentre-235"><a href="#ControlCentre-235"><span class="linenos">235</span></a>                <span class="n">interceptDistance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">evSpeed</span>
</span><span id="ControlCentre-236"><a href="#ControlCentre-236"><span class="linenos">236</span></a>
</span><span id="ControlCentre-237"><a href="#ControlCentre-237"><span class="linenos">237</span></a>            <span class="n">rendezvousEdge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findEdgePos</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="n">interceptDistance</span><span class="p">)</span>
</span><span id="ControlCentre-238"><a href="#ControlCentre-238"><span class="linenos">238</span></a>            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>       <span class="c1"># will normally only fail if drone cannot reach EV under straight line intercept assumptions</span>
</span><span id="ControlCentre-239"><a href="#ControlCentre-239"><span class="linenos">239</span></a>                <span class="n">posRV</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">convert2D</span><span class="p">(</span><span class="n">rendezvousEdge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">)</span>      <span class="c1"># get the x, y position after evCrowFlies metres</span>
</span><span id="ControlCentre-240"><a href="#ControlCentre-240"><span class="linenos">240</span></a>                <span class="c1"># Algorithm debug lines - show rendezvous point</span>
</span><span id="ControlCentre-241"><a href="#ControlCentre-241"><span class="linenos">241</span></a>                <span class="c1"># pid = ev + &quot; &quot; + str(timeStep)</span>
</span><span id="ControlCentre-242"><a href="#ControlCentre-242"><span class="linenos">242</span></a>                <span class="c1"># traci.poi.add(pid, posRV[0], posRV[1], color=(255, 0, 255), layer=250, imgFile=&quot;.\\PNG132.bmp&quot;, width=5, height=5)</span>
</span><span id="ControlCentre-243"><a href="#ControlCentre-243"><span class="linenos">243</span></a>            <span class="k">return</span> <span class="n">posRV</span>   <span class="c1"># this falls back to the original crow flies when straight line intercept fails</span>
</span><span id="ControlCentre-244"><a href="#ControlCentre-244"><span class="linenos">244</span></a>
</span><span id="ControlCentre-245"><a href="#ControlCentre-245"><span class="linenos">245</span></a>        <span class="c1"># print(timeStep, ev, drone, evCrowFlies, &quot;fail 2&quot;)  &#39;fail&#39; usually because vehicle has left simulation</span>
</span><span id="ControlCentre-246"><a href="#ControlCentre-246"><span class="linenos">246</span></a>        <span class="k">return</span> <span class="n">posDrone</span>   <span class="c1"># revert to direct intercept</span>
</span><span id="ControlCentre-247"><a href="#ControlCentre-247"><span class="linenos">247</span></a>
</span><span id="ControlCentre-248"><a href="#ControlCentre-248"><span class="linenos">248</span></a>    <span class="k">def</span> <span class="nf">getNeighboursNeedingCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">firstCall</span><span class="p">):</span>
</span><span id="ControlCentre-249"><a href="#ControlCentre-249"><span class="linenos">249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;find all the ev&#39;s that are requesting a charge and compute the mean distance to these</span>
</span><span id="ControlCentre-250"><a href="#ControlCentre-250"><span class="linenos">250</span></a><span class="sd">              note calling math.dist which will use sqrt is actually faster than comparing distances to the square</span>
</span><span id="ControlCentre-251"><a href="#ControlCentre-251"><span class="linenos">251</span></a><span class="sd">              we only update the ev positions on first call because we will repeat call to this fn for each ev in creating urgency list</span>
</span><span id="ControlCentre-252"><a href="#ControlCentre-252"><span class="linenos">252</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre-253"><a href="#ControlCentre-253"><span class="linenos">253</span></a>        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ControlCentre-254"><a href="#ControlCentre-254"><span class="linenos">254</span></a>        <span class="n">meanDist</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre-255"><a href="#ControlCentre-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="ControlCentre-256"><a href="#ControlCentre-256"><span class="linenos">256</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-257"><a href="#ControlCentre-257"><span class="linenos">257</span></a>        <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-258"><a href="#ControlCentre-258"><span class="linenos">258</span></a>
</span><span id="ControlCentre-259"><a href="#ControlCentre-259"><span class="linenos">259</span></a>        <span class="k">for</span> <span class="n">nEV</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre-260"><a href="#ControlCentre-260"><span class="linenos">260</span></a>            <span class="k">if</span> <span class="n">nEV</span> <span class="o">==</span> <span class="n">ev</span><span class="p">:</span>
</span><span id="ControlCentre-261"><a href="#ControlCentre-261"><span class="linenos">261</span></a>                <span class="k">continue</span>
</span><span id="ControlCentre-262"><a href="#ControlCentre-262"><span class="linenos">262</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="ControlCentre-263"><a href="#ControlCentre-263"><span class="linenos">263</span></a>                <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="ControlCentre-264"><a href="#ControlCentre-264"><span class="linenos">264</span></a>                    <span class="n">nEV</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-265"><a href="#ControlCentre-265"><span class="linenos">265</span></a>                <span class="n">vPos</span> <span class="o">=</span> <span class="n">nEV</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre-266"><a href="#ControlCentre-266"><span class="linenos">266</span></a>
</span><span id="ControlCentre-267"><a href="#ControlCentre-267"><span class="linenos">267</span></a>                <span class="n">xdist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">vPos</span><span class="p">)</span>
</span><span id="ControlCentre-268"><a href="#ControlCentre-268"><span class="linenos">268</span></a>                <span class="k">if</span> <span class="n">xdist</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">:</span>
</span><span id="ControlCentre-269"><a href="#ControlCentre-269"><span class="linenos">269</span></a>                    <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nEV</span><span class="p">)</span>
</span><span id="ControlCentre-270"><a href="#ControlCentre-270"><span class="linenos">270</span></a>                    <span class="n">meanDist</span> <span class="o">+=</span> <span class="n">xdist</span>
</span><span id="ControlCentre-271"><a href="#ControlCentre-271"><span class="linenos">271</span></a>            <span class="k">except</span> <span class="n">traci</span><span class="o">.</span><span class="n">TraCIException</span><span class="p">:</span>
</span><span id="ControlCentre-272"><a href="#ControlCentre-272"><span class="linenos">272</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;neighbour exception:&quot;</span><span class="p">,</span> <span class="n">traci</span><span class="o">.</span><span class="n">TraCIException</span><span class="p">)</span>
</span><span id="ControlCentre-273"><a href="#ControlCentre-273"><span class="linenos">273</span></a>                <span class="k">continue</span>
</span><span id="ControlCentre-274"><a href="#ControlCentre-274"><span class="linenos">274</span></a>
</span><span id="ControlCentre-275"><a href="#ControlCentre-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="n">meanDist</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>                      <span class="c1"># we have at least 1 ev so calculate the actual mean distance</span>
</span><span id="ControlCentre-276"><a href="#ControlCentre-276"><span class="linenos">276</span></a>            <span class="n">meanDist</span> <span class="o">=</span> <span class="n">meanDist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
</span><span id="ControlCentre-277"><a href="#ControlCentre-277"><span class="linenos">277</span></a>        <span class="k">return</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">meanDist</span>
</span><span id="ControlCentre-278"><a href="#ControlCentre-278"><span class="linenos">278</span></a>
</span><span id="ControlCentre-279"><a href="#ControlCentre-279"><span class="linenos">279</span></a>    <span class="k">def</span> <span class="nf">notifyDroneState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drone</span><span class="p">):</span>
</span><span id="ControlCentre-280"><a href="#ControlCentre-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Notification from Drone when charging finished or Drone has broken off the charge/flight&quot;&quot;&quot;</span>
</span><span id="ControlCentre-281"><a href="#ControlCentre-281"><span class="linenos">281</span></a>        <span class="k">if</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">:</span>
</span><span id="ControlCentre-282"><a href="#ControlCentre-282"><span class="linenos">282</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]]</span>
</span><span id="ControlCentre-283"><a href="#ControlCentre-283"><span class="linenos">283</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]</span>
</span><span id="ControlCentre-284"><a href="#ControlCentre-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">viable</span><span class="p">():</span>
</span><span id="ControlCentre-285"><a href="#ControlCentre-285"><span class="linenos">285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="ControlCentre-286"><a href="#ControlCentre-286"><span class="linenos">286</span></a>            <span class="k">if</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="ControlCentre-287"><a href="#ControlCentre-287"><span class="linenos">287</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="ControlCentre-288"><a href="#ControlCentre-288"><span class="linenos">288</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-289"><a href="#ControlCentre-289"><span class="linenos">289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="ControlCentre-290"><a href="#ControlCentre-290"><span class="linenos">290</span></a>
</span><span id="ControlCentre-291"><a href="#ControlCentre-291"><span class="linenos">291</span></a>    <span class="k">def</span> <span class="nf">notifyEVState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">evState</span><span class="p">,</span> <span class="n">drone</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
</span><span id="ControlCentre-292"><a href="#ControlCentre-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Notification from EV - when EV has left simulation (or completed charge)&quot;&quot;&quot;</span>
</span><span id="ControlCentre-293"><a href="#ControlCentre-293"><span class="linenos">293</span></a>        <span class="n">charge</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre-294"><a href="#ControlCentre-294"><span class="linenos">294</span></a>        <span class="k">match</span> <span class="n">evState</span><span class="p">:</span>
</span><span id="ControlCentre-295"><a href="#ControlCentre-295"><span class="linenos">295</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">DRIVING</span><span class="p">:</span>            <span class="c1"># means charge complete  so calculate charge</span>
</span><span id="ControlCentre-296"><a href="#ControlCentre-296"><span class="linenos">296</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="ControlCentre-297"><a href="#ControlCentre-297"><span class="linenos">297</span></a>                    <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre-298"><a href="#ControlCentre-298"><span class="linenos">298</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span>
</span><span id="ControlCentre-299"><a href="#ControlCentre-299"><span class="linenos">299</span></a>
</span><span id="ControlCentre-300"><a href="#ControlCentre-300"><span class="linenos">300</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEREQUESTED</span><span class="p">:</span>    <span class="c1"># just log request</span>
</span><span id="ControlCentre-301"><a href="#ControlCentre-301"><span class="linenos">301</span></a>                <span class="k">pass</span>
</span><span id="ControlCentre-302"><a href="#ControlCentre-302"><span class="linenos">302</span></a>
</span><span id="ControlCentre-303"><a href="#ControlCentre-303"><span class="linenos">303</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEBROKENOFF</span><span class="p">:</span>    <span class="c1"># drone broke off charge so should have an entry in self.startChargeEV</span>
</span><span id="ControlCentre-304"><a href="#ControlCentre-304"><span class="linenos">304</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="ControlCentre-305"><a href="#ControlCentre-305"><span class="linenos">305</span></a>                    <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre-306"><a href="#ControlCentre-306"><span class="linenos">306</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span>
</span><span id="ControlCentre-307"><a href="#ControlCentre-307"><span class="linenos">307</span></a>
</span><span id="ControlCentre-308"><a href="#ControlCentre-308"><span class="linenos">308</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGINGFROMDRONE</span><span class="p">:</span>      <span class="c1"># charge started</span>
</span><span id="ControlCentre-309"><a href="#ControlCentre-309"><span class="linenos">309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span>
</span><span id="ControlCentre-310"><a href="#ControlCentre-310"><span class="linenos">310</span></a>
</span><span id="ControlCentre-311"><a href="#ControlCentre-311"><span class="linenos">311</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">LEFTSIMULATION</span><span class="p">:</span>
</span><span id="ControlCentre-312"><a href="#ControlCentre-312"><span class="linenos">312</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="ControlCentre-313"><a href="#ControlCentre-313"><span class="linenos">313</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-314"><a href="#ControlCentre-314"><span class="linenos">314</span></a>                        <span class="k">if</span> <span class="n">drone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ControlCentre-315"><a href="#ControlCentre-315"><span class="linenos">315</span></a>                            <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre-316"><a href="#ControlCentre-316"><span class="linenos">316</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-317"><a href="#ControlCentre-317"><span class="linenos">317</span></a>                            <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre-318"><a href="#ControlCentre-318"><span class="linenos">318</span></a>                <span class="k">if</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre-319"><a href="#ControlCentre-319"><span class="linenos">319</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre-320"><a href="#ControlCentre-320"><span class="linenos">320</span></a>                <span class="k">elif</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">:</span>
</span><span id="ControlCentre-321"><a href="#ControlCentre-321"><span class="linenos">321</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]]</span>
</span><span id="ControlCentre-322"><a href="#ControlCentre-322"><span class="linenos">322</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre-323"><a href="#ControlCentre-323"><span class="linenos">323</span></a>
</span><span id="ControlCentre-324"><a href="#ControlCentre-324"><span class="linenos">324</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">WAITINGFORRENDEZVOUS</span><span class="p">:</span>   <span class="c1"># don&#39;t see this yet</span>
</span><span id="ControlCentre-325"><a href="#ControlCentre-325"><span class="linenos">325</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="s2">&quot;rv&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-326"><a href="#ControlCentre-326"><span class="linenos">326</span></a>
</span><span id="ControlCentre-327"><a href="#ControlCentre-327"><span class="linenos">327</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">WAITINGFORDRONE</span><span class="p">:</span>        <span class="c1"># don&#39;t see this</span>
</span><span id="ControlCentre-328"><a href="#ControlCentre-328"><span class="linenos">328</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="s2">&quot;wd&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-329"><a href="#ControlCentre-329"><span class="linenos">329</span></a>
</span><span id="ControlCentre-330"><a href="#ControlCentre-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">chargePrint</span><span class="p">:</span>
</span><span id="ControlCentre-331"><a href="#ControlCentre-331"><span class="linenos">331</span></a>            <span class="n">droneID</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
</span><span id="ControlCentre-332"><a href="#ControlCentre-332"><span class="linenos">332</span></a>            <span class="k">if</span> <span class="n">drone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ControlCentre-333"><a href="#ControlCentre-333"><span class="linenos">333</span></a>                <span class="n">droneID</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
</span><span id="ControlCentre-334"><a href="#ControlCentre-334"><span class="linenos">334</span></a>
</span><span id="ControlCentre-335"><a href="#ControlCentre-335"><span class="linenos">335</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="n">evState</span><span class="p">,</span> <span class="n">droneID</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">charge</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">GG</span><span class="o">.</span><span class="n">chargeLog</span><span class="p">)</span>
</span><span id="ControlCentre-336"><a href="#ControlCentre-336"><span class="linenos">336</span></a>
</span><span id="ControlCentre-337"><a href="#ControlCentre-337"><span class="linenos">337</span></a>    <span class="k">def</span> <span class="nf">printDroneStatistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brief</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span><span id="ControlCentre-338"><a href="#ControlCentre-338"><span class="linenos">338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Print out Drone and EV statistics for the complete run&quot;&quot;&quot;</span>
</span><span id="ControlCentre-339"><a href="#ControlCentre-339"><span class="linenos">339</span></a>        <span class="c1"># compute drone statistic totals</span>
</span><span id="ControlCentre-340"><a href="#ControlCentre-340"><span class="linenos">340</span></a>        <span class="n">tmyFlyingCount</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># used to compute distance travelled</span>
</span><span id="ControlCentre-341"><a href="#ControlCentre-341"><span class="linenos">341</span></a>        <span class="n">tmyFullCharges</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># count of complete charges</span>
</span><span id="ControlCentre-342"><a href="#ControlCentre-342"><span class="linenos">342</span></a>        <span class="n">tmyBrokenCharges</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># count of charges broken off - either by me out of charge</span>
</span><span id="ControlCentre-343"><a href="#ControlCentre-343"><span class="linenos">343</span></a>        <span class="n">tmyBrokenEVCharges</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># count of charges broken off - by EV leaving</span>
</span><span id="ControlCentre-344"><a href="#ControlCentre-344"><span class="linenos">344</span></a>        <span class="n">tmyFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>           <span class="c1"># wH i&#39;ve used flying</span>
</span><span id="ControlCentre-345"><a href="#ControlCentre-345"><span class="linenos">345</span></a>        <span class="n">tmyChargingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>         <span class="c1"># wH i&#39;ve used charging EVs</span>
</span><span id="ControlCentre-346"><a href="#ControlCentre-346"><span class="linenos">346</span></a>        <span class="n">tmyChargeMeFlyingCount</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># wh i&#39;ve charged my flying battery</span>
</span><span id="ControlCentre-347"><a href="#ControlCentre-347"><span class="linenos">347</span></a>        <span class="n">tmyChargeMeCount</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># wh i&#39;ve used charging my EV charging battery</span>
</span><span id="ControlCentre-348"><a href="#ControlCentre-348"><span class="linenos">348</span></a>        <span class="n">tmyResidualChargeKWh</span> <span class="o">=</span> <span class="mf">0.0</span>   <span class="c1"># Wh left in charge battery at end</span>
</span><span id="ControlCentre-349"><a href="#ControlCentre-349"><span class="linenos">349</span></a>        <span class="n">tmyResidualFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>   <span class="c1"># Wh left in flying battery at end</span>
</span><span id="ControlCentre-350"><a href="#ControlCentre-350"><span class="linenos">350</span></a>        <span class="n">tmyChaseCount</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># no of successful chases  (ie successfully got from rendezvous to EV)</span>
</span><span id="ControlCentre-351"><a href="#ControlCentre-351"><span class="linenos">351</span></a>        <span class="n">tmyBrokenChaseCount</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c1"># no of broken chases  (vehicle left after rendezvous but before drone got there)</span>
</span><span id="ControlCentre-352"><a href="#ControlCentre-352"><span class="linenos">352</span></a>        <span class="n">tmyChaseSteps</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># steps for succesful chases - used to compute average chase time</span>
</span><span id="ControlCentre-353"><a href="#ControlCentre-353"><span class="linenos">353</span></a>
</span><span id="ControlCentre-354"><a href="#ControlCentre-354"><span class="linenos">354</span></a>        <span class="n">tDroneDistance</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre-355"><a href="#ControlCentre-355"><span class="linenos">355</span></a>        <span class="n">tmyChargeMeFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre-356"><a href="#ControlCentre-356"><span class="linenos">356</span></a>        <span class="n">tmyChargeMeKWh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre-357"><a href="#ControlCentre-357"><span class="linenos">357</span></a>
</span><span id="ControlCentre-358"><a href="#ControlCentre-358"><span class="linenos">358</span></a>        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">):</span>
</span><span id="ControlCentre-359"><a href="#ControlCentre-359"><span class="linenos">359</span></a>            <span class="n">tmyFlyingCount</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span>
</span><span id="ControlCentre-360"><a href="#ControlCentre-360"><span class="linenos">360</span></a>            <span class="n">tmyFlyingKWh</span>            <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneFlyingWhperTimeStep</span>
</span><span id="ControlCentre-361"><a href="#ControlCentre-361"><span class="linenos">361</span></a>
</span><span id="ControlCentre-362"><a href="#ControlCentre-362"><span class="linenos">362</span></a>            <span class="n">tDroneDistance</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneStepMperTimeStep</span>
</span><span id="ControlCentre-363"><a href="#ControlCentre-363"><span class="linenos">363</span></a>
</span><span id="ControlCentre-364"><a href="#ControlCentre-364"><span class="linenos">364</span></a>            <span class="n">tmyFullCharges</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFullCharges</span>
</span><span id="ControlCentre-365"><a href="#ControlCentre-365"><span class="linenos">365</span></a>            <span class="n">tmyBrokenCharges</span>        <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenCharges</span>
</span><span id="ControlCentre-366"><a href="#ControlCentre-366"><span class="linenos">366</span></a>            <span class="n">tmyBrokenEVCharges</span>      <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenEVCharges</span>
</span><span id="ControlCentre-367"><a href="#ControlCentre-367"><span class="linenos">367</span></a>
</span><span id="ControlCentre-368"><a href="#ControlCentre-368"><span class="linenos">368</span></a>            <span class="n">tmyChargingKWh</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myEVChargingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre-369"><a href="#ControlCentre-369"><span class="linenos">369</span></a>            <span class="n">tmyChargeMeFlyingCount</span>  <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeFlyingCount</span>
</span><span id="ControlCentre-370"><a href="#ControlCentre-370"><span class="linenos">370</span></a>            <span class="n">tmyChargeMeFlyingKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhDroneRechargePerTimeStep</span>
</span><span id="ControlCentre-371"><a href="#ControlCentre-371"><span class="linenos">371</span></a>            <span class="n">tmyChargeMeCount</span>        <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeCount</span>
</span><span id="ControlCentre-372"><a href="#ControlCentre-372"><span class="linenos">372</span></a>            <span class="n">tmyChargeMeKWh</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhDroneRechargePerTimeStep</span>
</span><span id="ControlCentre-373"><a href="#ControlCentre-373"><span class="linenos">373</span></a>
</span><span id="ControlCentre-374"><a href="#ControlCentre-374"><span class="linenos">374</span></a>            <span class="n">tmyResidualFlyingKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCharge</span>
</span><span id="ControlCentre-375"><a href="#ControlCentre-375"><span class="linenos">375</span></a>            <span class="n">tmyResidualChargeKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myCharge</span>
</span><span id="ControlCentre-376"><a href="#ControlCentre-376"><span class="linenos">376</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre-377"><a href="#ControlCentre-377"><span class="linenos">377</span></a>                <span class="n">tmyChaseCount</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChaseCount</span>
</span><span id="ControlCentre-378"><a href="#ControlCentre-378"><span class="linenos">378</span></a>                <span class="n">tmyBrokenChaseCount</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenChaseCount</span>
</span><span id="ControlCentre-379"><a href="#ControlCentre-379"><span class="linenos">379</span></a>                <span class="n">tmyChaseSteps</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChaseSteps</span>
</span><span id="ControlCentre-380"><a href="#ControlCentre-380"><span class="linenos">380</span></a>
</span><span id="ControlCentre-381"><a href="#ControlCentre-381"><span class="linenos">381</span></a>        <span class="c1"># alternative computation - avoiding errors from addition of large no of floating point</span>
</span><span id="ControlCentre-382"><a href="#ControlCentre-382"><span class="linenos">382</span></a>        <span class="c1"># tmyFlyingKWh = tmyFlyingCount * Drone.droneFlyingWhperTimeStep / 1000.</span>
</span><span id="ControlCentre-383"><a href="#ControlCentre-383"><span class="linenos">383</span></a>        <span class="n">tDroneDistance</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-384"><a href="#ControlCentre-384"><span class="linenos">384</span></a>        <span class="n">tmyFlyingKWh</span>          <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-385"><a href="#ControlCentre-385"><span class="linenos">385</span></a>        <span class="n">tmyChargingKWh</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-386"><a href="#ControlCentre-386"><span class="linenos">386</span></a>        <span class="n">tmyChargeMeFlyingKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-387"><a href="#ControlCentre-387"><span class="linenos">387</span></a>        <span class="n">tmyChargeMeKWh</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-388"><a href="#ControlCentre-388"><span class="linenos">388</span></a>        <span class="n">tmyResidualFlyingKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-389"><a href="#ControlCentre-389"><span class="linenos">389</span></a>        <span class="n">tmyResidualChargeKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-390"><a href="#ControlCentre-390"><span class="linenos">390</span></a>
</span><span id="ControlCentre-391"><a href="#ControlCentre-391"><span class="linenos">391</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre-392"><a href="#ControlCentre-392"><span class="linenos">392</span></a>            <span class="c1"># note chases + broken chases usually less than charge sessions total because some will break off before they get to rendezvous</span>
</span><span id="ControlCentre-393"><a href="#ControlCentre-393"><span class="linenos">393</span></a>            <span class="c1"># ie chases are between rendezvous point and beginning charging - indicator of efficiency of rendezvous algorithm</span>
</span><span id="ControlCentre-394"><a href="#ControlCentre-394"><span class="linenos">394</span></a>            <span class="k">if</span> <span class="n">tmyChaseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-395"><a href="#ControlCentre-395"><span class="linenos">395</span></a>                <span class="n">averageChase</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmyChaseSteps</span> <span class="o">*</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">stepSecs</span><span class="p">)</span><span class="o">/</span><span class="n">tmyChaseCount</span>
</span><span id="ControlCentre-396"><a href="#ControlCentre-396"><span class="linenos">396</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-397"><a href="#ControlCentre-397"><span class="linenos">397</span></a>                <span class="n">averageChase</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre-398"><a href="#ControlCentre-398"><span class="linenos">398</span></a>
</span><span id="ControlCentre-399"><a href="#ControlCentre-399"><span class="linenos">399</span></a>        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="ControlCentre-400"><a href="#ControlCentre-400"><span class="linenos">400</span></a>        <span class="c1"># all done, dump the distance travelled by the drones and KW used</span>
</span><span id="ControlCentre-401"><a href="#ControlCentre-401"><span class="linenos">401</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1">#  tidy up after the ....</span>
</span><span id="ControlCentre-402"><a href="#ControlCentre-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">brief</span><span class="p">:</span>
</span><span id="ControlCentre-403"><a href="#ControlCentre-403"><span class="linenos">403</span></a>            <span class="n">sumoVersion</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span>
</span><span id="ControlCentre-404"><a href="#ControlCentre-404"><span class="linenos">404</span></a>            <span class="n">runstring</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
</span><span id="ControlCentre-405"><a href="#ControlCentre-405"><span class="linenos">405</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Date</span><span class="se">\t</span><span class="s2">Rv</span><span class="se">\t</span><span class="s2">Once</span><span class="se">\t</span><span class="s2">Output</span><span class="se">\t</span><span class="s2">wE</span><span class="se">\t</span><span class="s2">wU</span><span class="se">\t</span><span class="s2">radius</span><span class="se">\t</span><span class="s2">Steps</span><span class="se">\t</span><span class="s2"># Drones&quot;</span>
</span><span id="ControlCentre-406"><a href="#ControlCentre-406"><span class="linenos">406</span></a>                  <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Distance</span><span class="se">\t</span><span class="s2">FlyKWh</span><span class="se">\t</span><span class="s2">chKWh</span><span class="se">\t</span><span class="s2">FlyChgKWh</span><span class="se">\t</span><span class="s2">ChgKWh</span><span class="se">\t</span><span class="s2">rFlyKWh</span><span class="se">\t</span><span class="s2">rChKWh&quot;</span>
</span><span id="ControlCentre-407"><a href="#ControlCentre-407"><span class="linenos">407</span></a>                  <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"># EVs</span><span class="se">\t</span><span class="s2">EVChg</span><span class="se">\t</span><span class="s2">EVgap</span><span class="se">\t</span><span class="s2">Full</span><span class="se">\t</span><span class="s2">brDrone</span><span class="se">\t</span><span class="s2">brEV</span><span class="se">\t</span><span class="s2">Chases</span><span class="se">\t</span><span class="s2">Avg Chase</span><span class="se">\t</span><span class="s2">Brk Chase&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-408"><a href="#ControlCentre-408"><span class="linenos">408</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre-409"><a href="#ControlCentre-409"><span class="linenos">409</span></a>                  <span class="p">(</span><span class="n">timeStamp</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">onlyChargeOnce</span><span class="p">,</span>
</span><span id="ControlCentre-410"><a href="#ControlCentre-410"><span class="linenos">410</span></a>                   <span class="n">GG</span><span class="o">.</span><span class="n">dronePrint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="ControlCentre-411"><a href="#ControlCentre-411"><span class="linenos">411</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span><span class="p">,</span> <span class="n">tDroneDistance</span><span class="p">,</span> <span class="n">tmyFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargingKWh</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-412"><a href="#ControlCentre-412"><span class="linenos">412</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre-413"><a href="#ControlCentre-413"><span class="linenos">413</span></a>                  <span class="p">(</span><span class="n">tmyChargeMeFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargeMeKWh</span><span class="p">,</span> <span class="n">tmyResidualFlyingKWh</span><span class="p">,</span> <span class="n">tmyResidualChargeKWh</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-414"><a href="#ControlCentre-414"><span class="linenos">414</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre-415"><a href="#ControlCentre-415"><span class="linenos">415</span></a>                  <span class="p">(</span><span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeSteps</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeGap</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-416"><a href="#ControlCentre-416"><span class="linenos">416</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmyFullCharges</span><span class="p">,</span> <span class="n">tmyBrokenCharges</span><span class="p">,</span> <span class="n">tmyBrokenEVCharges</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-417"><a href="#ControlCentre-417"><span class="linenos">417</span></a>
</span><span id="ControlCentre-418"><a href="#ControlCentre-418"><span class="linenos">418</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre-419"><a href="#ControlCentre-419"><span class="linenos">419</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmyChaseCount</span><span class="p">,</span> <span class="n">averageChase</span><span class="p">,</span> <span class="n">tmyBrokenChaseCount</span><span class="p">,</span> <span class="n">runstring</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">sumoVersion</span><span class="p">))</span>
</span><span id="ControlCentre-420"><a href="#ControlCentre-420"><span class="linenos">420</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-421"><a href="#ControlCentre-421"><span class="linenos">421</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runstring</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">sumoVersion</span><span class="p">))</span>
</span><span id="ControlCentre-422"><a href="#ControlCentre-422"><span class="linenos">422</span></a>
</span><span id="ControlCentre-423"><a href="#ControlCentre-423"><span class="linenos">423</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre-424"><a href="#ControlCentre-424"><span class="linenos">424</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary Statistics:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timeStamp</span><span class="p">)</span>
</span><span id="ControlCentre-425"><a href="#ControlCentre-425"><span class="linenos">425</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Model flags:</span><span class="se">\t</span><span class="s2">Rendezvous: </span><span class="si">{!r}</span><span class="se">\t</span><span class="s2">Charge Once: </span><span class="si">{!r}</span><span class="se">\t</span><span class="s2">Drone print: </span><span class="si">{!r}</span><span class="se">\n\t</span><span class="s2">Energy Weight: &quot;</span>
</span><span id="ControlCentre-426"><a href="#ControlCentre-426"><span class="linenos">426</span></a>                  <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="s2">Urgency Weight: </span><span class="si">{:.1f}</span><span class="se">\t</span><span class="s2">Proximity radius(m): </span><span class="si">{:.0f}</span><span class="se">\t</span><span class="s2">Time steps: </span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre-427"><a href="#ControlCentre-427"><span class="linenos">427</span></a>                  <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">onlyChargeOnce</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">dronePrint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">,</span>
</span><span id="ControlCentre-428"><a href="#ControlCentre-428"><span class="linenos">428</span></a>                   <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">))</span>
</span><span id="ControlCentre-429"><a href="#ControlCentre-429"><span class="linenos">429</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Drone Totals:</span><span class="se">\t</span><span class="s2">(</span><span class="si">%i</span><span class="s2"> drones)</span><span class="se">\n\t\t</span><span class="s2">Distance Km:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n\t\t</span><span class="s2">Charging KWh:</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre-430"><a href="#ControlCentre-430"><span class="linenos">430</span></a>                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span><span class="p">,</span> <span class="n">tDroneDistance</span><span class="p">,</span> <span class="n">tmyFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargingKWh</span><span class="p">))</span>
</span><span id="ControlCentre-431"><a href="#ControlCentre-431"><span class="linenos">431</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Drone Charger usage:</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\n\t\t</span><span class="s2">Charge KWh:</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre-432"><a href="#ControlCentre-432"><span class="linenos">432</span></a>                  <span class="p">(</span><span class="n">tmyChargeMeFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargeMeKWh</span><span class="p">))</span>
</span><span id="ControlCentre-433"><a href="#ControlCentre-433"><span class="linenos">433</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Residuals:</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\n\t\t</span><span class="s2">Charging KWh:</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre-434"><a href="#ControlCentre-434"><span class="linenos">434</span></a>                  <span class="p">(</span><span class="n">tmyResidualFlyingKWh</span><span class="p">,</span> <span class="n">tmyResidualChargeKWh</span><span class="p">))</span>
</span><span id="ControlCentre-435"><a href="#ControlCentre-435"><span class="linenos">435</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">EV Totals:</span><span class="se">\t</span><span class="s2">(</span><span class="si">%i</span><span class="s2"> EVs)</span><span class="se">\n\t\t</span><span class="s2">Charge KWh:</span><span class="se">\t</span><span class="si">%.1f</span><span class="se">\n\t\t</span><span class="s2">Charge Gap KWh:</span><span class="se">\t</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre-436"><a href="#ControlCentre-436"><span class="linenos">436</span></a>                  <span class="p">(</span><span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeSteps</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeGap</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">)))</span>
</span><span id="ControlCentre-437"><a href="#ControlCentre-437"><span class="linenos">437</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Charge Sessions:</span><span class="se">\n\t\t\t</span><span class="s2">Full charges:</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\n\t\t\t</span><span class="s2">Part (drone):</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\n\t\t\t</span><span class="s2">Part (ev):</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre-438"><a href="#ControlCentre-438"><span class="linenos">438</span></a>                  <span class="p">(</span><span class="n">tmyFullCharges</span><span class="p">,</span> <span class="n">tmyBrokenCharges</span><span class="p">,</span> <span class="n">tmyBrokenEVCharges</span><span class="p">))</span>
</span><span id="ControlCentre-439"><a href="#ControlCentre-439"><span class="linenos">439</span></a>
</span><span id="ControlCentre-440"><a href="#ControlCentre-440"><span class="linenos">440</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre-441"><a href="#ControlCentre-441"><span class="linenos">441</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Successful chases: </span><span class="si">%i</span><span class="se">\t</span><span class="s2">Average chase time: </span><span class="si">%.1f</span><span class="s2">s</span><span class="se">\t</span><span class="s2">broken Chases: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre-442"><a href="#ControlCentre-442"><span class="linenos">442</span></a>                      <span class="p">(</span><span class="n">tmyChaseCount</span><span class="p">,</span> <span class="n">averageChase</span><span class="p">,</span> <span class="n">tmyBrokenChaseCount</span><span class="p">))</span>
</span><span id="ControlCentre-443"><a href="#ControlCentre-443"><span class="linenos">443</span></a>
</span><span id="ControlCentre-444"><a href="#ControlCentre-444"><span class="linenos">444</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Discrete Drone data:&quot;</span><span class="p">)</span>
</span><span id="ControlCentre-445"><a href="#ControlCentre-445"><span class="linenos">445</span></a>            <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">)):</span>
</span><span id="ControlCentre-446"><a href="#ControlCentre-446"><span class="linenos">446</span></a>                <span class="n">droneDistance</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneStepMperTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-447"><a href="#ControlCentre-447"><span class="linenos">447</span></a>                <span class="n">droneFlyingKWh</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneFlyingWhperTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-448"><a href="#ControlCentre-448"><span class="linenos">448</span></a>                <span class="n">droneChargeKWh</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myEVChargingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre-449"><a href="#ControlCentre-449"><span class="linenos">449</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">drone:</span><span class="si">{}</span><span class="se">\t</span><span class="s2">Km:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">Charge KW:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">FlyingKW:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">Residual (chargeWh:</span><span class="si">{:.0f}</span><span class="s2"> flyingWh:</span><span class="si">{:.0f}</span><span class="s2">)&quot;</span>
</span><span id="ControlCentre-450"><a href="#ControlCentre-450"><span class="linenos">450</span></a>                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">droneDistance</span><span class="p">,</span> <span class="n">droneChargeKWh</span><span class="p">,</span> <span class="n">droneFlyingKWh</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">myCharge</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCharge</span><span class="p">))</span>
</span><span id="ControlCentre-451"><a href="#ControlCentre-451"><span class="linenos">451</span></a>
</span><span id="ControlCentre-452"><a href="#ControlCentre-452"><span class="linenos">452</span></a>    <span class="k">def</span> <span class="nf">requestCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">requestedWh</span><span class="o">=</span><span class="mf">2000.</span><span class="p">):</span>
</span><span id="ControlCentre-453"><a href="#ControlCentre-453"><span class="linenos">453</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;request for charge from EV&quot;&quot;&quot;</span>
</span><span id="ControlCentre-454"><a href="#ControlCentre-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestedWh</span>
</span><span id="ControlCentre-455"><a href="#ControlCentre-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">chargePrint</span><span class="p">:</span>
</span><span id="ControlCentre-456"><a href="#ControlCentre-456"><span class="linenos">456</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEREQUESTED</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">requestedWh</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">GG</span><span class="o">.</span><span class="n">chargeLog</span><span class="p">)</span>
</span><span id="ControlCentre-457"><a href="#ControlCentre-457"><span class="linenos">457</span></a>
</span><span id="ControlCentre-458"><a href="#ControlCentre-458"><span class="linenos">458</span></a>    <span class="k">def</span> <span class="nf">setMaxDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmaxDrones</span><span class="p">):</span>
</span><span id="ControlCentre-459"><a href="#ControlCentre-459"><span class="linenos">459</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; update maxDrones - when --z option is used drones are limited to those in the add file&quot;&quot;&quot;</span>
</span><span id="ControlCentre-460"><a href="#ControlCentre-460"><span class="linenos">460</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">=</span> <span class="n">pmaxDrones</span>
</span><span id="ControlCentre-461"><a href="#ControlCentre-461"><span class="linenos">461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">syncSpawnedDrones</span><span class="p">()</span>
</span><span id="ControlCentre-462"><a href="#ControlCentre-462"><span class="linenos">462</span></a>
</span><span id="ControlCentre-463"><a href="#ControlCentre-463"><span class="linenos">463</span></a>    <span class="k">def</span> <span class="nf">syncSpawnedDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre-464"><a href="#ControlCentre-464"><span class="linenos">464</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;if we&#39;ve generated drones from POI definitions in the add file we need to update our spawnedDrone count&quot;&quot;&quot;</span>
</span><span id="ControlCentre-465"><a href="#ControlCentre-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">=</span> <span class="n">Drone</span><span class="o">.</span><span class="n">getIDCount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="ControlCentre-466"><a href="#ControlCentre-466"><span class="linenos">466</span></a>
</span><span id="ControlCentre-467"><a href="#ControlCentre-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="nf">tidyDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre-468"><a href="#ControlCentre-468"><span class="linenos">468</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;remove any dummy vehicles left after all vehicles have left - ie simulation has finished&quot;&quot;&quot;</span>
</span><span id="ControlCentre-469"><a href="#ControlCentre-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertedDummies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-470"><a href="#ControlCentre-470"><span class="linenos">470</span></a>            <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="ControlCentre-471"><a href="#ControlCentre-471"><span class="linenos">471</span></a>                <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDummyEVInserted</span><span class="p">:</span>
</span><span id="ControlCentre-472"><a href="#ControlCentre-472"><span class="linenos">472</span></a>                    <span class="n">drone</span><span class="o">.</span><span class="n">dummyEVHide</span><span class="p">()</span>
</span><span id="ControlCentre-473"><a href="#ControlCentre-473"><span class="linenos">473</span></a>
</span><span id="ControlCentre-474"><a href="#ControlCentre-474"><span class="linenos">474</span></a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre-475"><a href="#ControlCentre-475"><span class="linenos">475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Management of &#39;control centre&#39; executed by simulation on every step&quot;&quot;&quot;</span>
</span><span id="ControlCentre-476"><a href="#ControlCentre-476"><span class="linenos">476</span></a>        <span class="n">availableDrones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span>
</span><span id="ControlCentre-477"><a href="#ControlCentre-477"><span class="linenos">477</span></a>        <span class="k">if</span> <span class="n">availableDrones</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre-478"><a href="#ControlCentre-478"><span class="linenos">478</span></a>            <span class="n">urgencyList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcUrgency</span><span class="p">()</span>
</span><span id="ControlCentre-479"><a href="#ControlCentre-479"><span class="linenos">479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">allocateDrones</span><span class="p">(</span><span class="n">urgencyList</span><span class="p">)</span>
</span><span id="ControlCentre-480"><a href="#ControlCentre-480"><span class="linenos">480</span></a>            <span class="k">del</span> <span class="n">urgencyList</span>
</span><span id="ControlCentre-481"><a href="#ControlCentre-481"><span class="linenos">481</span></a>        <span class="c1"># Control centre manages parking/charging of drones</span>
</span><span id="ControlCentre-482"><a href="#ControlCentre-482"><span class="linenos">482</span></a>        <span class="c1"># each EV &#39;manages&#39; the drone allocated to them</span>
</span><span id="ControlCentre-483"><a href="#ControlCentre-483"><span class="linenos">483</span></a>        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="ControlCentre-484"><a href="#ControlCentre-484"><span class="linenos">484</span></a>            <span class="n">drone</span><span class="o">.</span><span class="n">parkingUpdate</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Main class receiving requests from EV's and notifications from Drones and EV's when charge completes or Drone is out of battery</p>
</div>


                            <div id="ControlCentre.__init__" class="classattr">
                                        <input id="ControlCentre.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ControlCentre</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wEnergy</span>, </span><span class="param"><span class="n">wUrgency</span>, </span><span class="param"><span class="n">proximityRadius</span>, </span><span class="param"><span class="n">maxDrones</span>, </span><span class="param"><span class="n">droneType</span><span class="o">=</span><span class="s1">&#39;ehang184&#39;</span></span>)</span>

                <label class="view-source-button" for="ControlCentre.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.__init__-15"><a href="#ControlCentre.__init__-15"><span class="linenos">15</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wEnergy</span><span class="p">,</span> <span class="n">wUrgency</span><span class="p">,</span> <span class="n">proximityRadius</span><span class="p">,</span> <span class="n">maxDrones</span><span class="p">,</span> <span class="n">droneType</span><span class="o">=</span><span class="s2">&quot;ehang184&quot;</span><span class="p">):</span>
</span><span id="ControlCentre.__init__-16"><a href="#ControlCentre.__init__-16"><span class="linenos">16</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wEnergy</span><span class="p">)</span>
</span><span id="ControlCentre.__init__-17"><a href="#ControlCentre.__init__-17"><span class="linenos">17</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wUrgency</span><span class="p">)</span>
</span><span id="ControlCentre.__init__-18"><a href="#ControlCentre.__init__-18"><span class="linenos">18</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span> <span class="o">=</span> <span class="n">proximityRadius</span>
</span><span id="ControlCentre.__init__-19"><a href="#ControlCentre.__init__-19"><span class="linenos">19</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">=</span> <span class="n">maxDrones</span>
</span><span id="ControlCentre.__init__-20"><a href="#ControlCentre.__init__-20"><span class="linenos">20</span></a>
</span><span id="ControlCentre.__init__-21"><a href="#ControlCentre.__init__-21"><span class="linenos">21</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre.__init__-22"><a href="#ControlCentre.__init__-22"><span class="linenos">22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre.__init__-23"><a href="#ControlCentre.__init__-23"><span class="linenos">23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre.__init__-24"><a href="#ControlCentre.__init__-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre.__init__-25"><a href="#ControlCentre.__init__-25"><span class="linenos">25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ControlCentre.__init__-26"><a href="#ControlCentre.__init__-26"><span class="linenos">26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ControlCentre.__init__-27"><a href="#ControlCentre.__init__-27"><span class="linenos">27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">droneType</span> <span class="o">=</span> <span class="n">droneType</span>
</span><span id="ControlCentre.__init__-28"><a href="#ControlCentre.__init__-28"><span class="linenos">28</span></a>
</span><span id="ControlCentre.__init__-29"><a href="#ControlCentre.__init__-29"><span class="linenos">29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre.__init__-30"><a href="#ControlCentre.__init__-30"><span class="linenos">30</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">insertedDummies</span> <span class="o">=</span> <span class="mi">0</span>
</span></pre></div>


    

                            </div>
                            <div id="ControlCentre.wEnergy" class="classattr">
                                <div class="attr variable">
            <span class="name">wEnergy</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.wEnergy"></a>
    
    

                            </div>
                            <div id="ControlCentre.wUrgency" class="classattr">
                                <div class="attr variable">
            <span class="name">wUrgency</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.wUrgency"></a>
    
    

                            </div>
                            <div id="ControlCentre.proximityRadius" class="classattr">
                                <div class="attr variable">
            <span class="name">proximityRadius</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.proximityRadius"></a>
    
    

                            </div>
                            <div id="ControlCentre.maxDrones" class="classattr">
                                <div class="attr variable">
            <span class="name">maxDrones</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.maxDrones"></a>
    
    

                            </div>
                            <div id="ControlCentre.requests" class="classattr">
                                <div class="attr variable">
            <span class="name">requests</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.requests"></a>
    
    

                            </div>
                            <div id="ControlCentre.allocatedEV" class="classattr">
                                <div class="attr variable">
            <span class="name">allocatedEV</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.allocatedEV"></a>
    
    

                            </div>
                            <div id="ControlCentre.startChargeEV" class="classattr">
                                <div class="attr variable">
            <span class="name">startChargeEV</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.startChargeEV"></a>
    
    

                            </div>
                            <div id="ControlCentre.allocatedDrone" class="classattr">
                                <div class="attr variable">
            <span class="name">allocatedDrone</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.allocatedDrone"></a>
    
    

                            </div>
                            <div id="ControlCentre.freeDrones" class="classattr">
                                <div class="attr variable">
            <span class="name">freeDrones</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.freeDrones"></a>
    
    

                            </div>
                            <div id="ControlCentre.needChargeDrones" class="classattr">
                                <div class="attr variable">
            <span class="name">needChargeDrones</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.needChargeDrones"></a>
    
    

                            </div>
                            <div id="ControlCentre.droneType" class="classattr">
                                <div class="attr variable">
            <span class="name">droneType</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.droneType"></a>
    
    

                            </div>
                            <div id="ControlCentre.spawnedDrones" class="classattr">
                                <div class="attr variable">
            <span class="name">spawnedDrones</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.spawnedDrones"></a>
    
    

                            </div>
                            <div id="ControlCentre.insertedDummies" class="classattr">
                                <div class="attr variable">
            <span class="name">insertedDummies</span>

        
    </div>
    <a class="headerlink" href="#ControlCentre.insertedDummies"></a>
    
    

                            </div>
                            <div id="ControlCentre.allocate" class="classattr">
                                        <input id="ControlCentre.allocate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">allocate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">drone</span>, </span><span class="param"><span class="n">ev</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.allocate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.allocate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.allocate-33"><a href="#ControlCentre.allocate-33"><span class="linenos">33</span></a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
</span><span id="ControlCentre.allocate-34"><a href="#ControlCentre.allocate-34"><span class="linenos">34</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the mapping between drone and ev&quot;&quot;&quot;</span>
</span><span id="ControlCentre.allocate-35"><a href="#ControlCentre.allocate-35"><span class="linenos">35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">drone</span>
</span><span id="ControlCentre.allocate-36"><a href="#ControlCentre.allocate-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span>
</span><span id="ControlCentre.allocate-37"><a href="#ControlCentre.allocate-37"><span class="linenos">37</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre.allocate-38"><a href="#ControlCentre.allocate-38"><span class="linenos">38</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">findRendezvousXY</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">drone</span><span class="p">))</span>
</span><span id="ControlCentre.allocate-39"><a href="#ControlCentre.allocate-39"><span class="linenos">39</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.allocate-40"><a href="#ControlCentre.allocate-40"><span class="linenos">40</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre.allocate-41"><a href="#ControlCentre.allocate-41"><span class="linenos">41</span></a>        <span class="n">requestedWh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre.allocate-42"><a href="#ControlCentre.allocate-42"><span class="linenos">42</span></a>        <span class="n">drone</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">requestedWh</span><span class="p">)</span>
</span><span id="ControlCentre.allocate-43"><a href="#ControlCentre.allocate-43"><span class="linenos">43</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre.allocate-44"><a href="#ControlCentre.allocate-44"><span class="linenos">44</span></a>        <span class="c1">#print(&quot;allocation&quot;, GG.ss.timeStep, drone.getID(), ev.getID())</span>
</span></pre></div>


            <div class="docstring"><p>Set up the mapping between drone and ev</p>
</div>


                            </div>
                            <div id="ControlCentre.allocateDrones" class="classattr">
                                        <input id="ControlCentre.allocateDrones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">allocateDrones</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">urgencyList</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.allocateDrones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.allocateDrones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.allocateDrones-46"><a href="#ControlCentre.allocateDrones-46"><span class="linenos">46</span></a>    <span class="k">def</span> <span class="nf">allocateDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urgencyList</span><span class="p">):</span>
</span><span id="ControlCentre.allocateDrones-47"><a href="#ControlCentre.allocateDrones-47"><span class="linenos">47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate whatever drones we have free/viable in order of urgency,</span>
</span><span id="ControlCentre.allocateDrones-48"><a href="#ControlCentre.allocateDrones-48"><span class="linenos">48</span></a><span class="sd">            if more than one drone available assign the nearest&quot;&quot;&quot;</span>
</span><span id="ControlCentre.allocateDrones-49"><a href="#ControlCentre.allocateDrones-49"><span class="linenos">49</span></a>        <span class="n">ld</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-50"><a href="#ControlCentre.allocateDrones-50"><span class="linenos">50</span></a>        <span class="n">nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span>
</span><span id="ControlCentre.allocateDrones-51"><a href="#ControlCentre.allocateDrones-51"><span class="linenos">51</span></a>        <span class="k">if</span> <span class="n">ld</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-52"><a href="#ControlCentre.allocateDrones-52"><span class="linenos">52</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre.allocateDrones-53"><a href="#ControlCentre.allocateDrones-53"><span class="linenos">53</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-54"><a href="#ControlCentre.allocateDrones-54"><span class="linenos">54</span></a>                <span class="k">break</span>
</span><span id="ControlCentre.allocateDrones-55"><a href="#ControlCentre.allocateDrones-55"><span class="linenos">55</span></a>        <span class="k">elif</span> <span class="n">ld</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-56"><a href="#ControlCentre.allocateDrones-56"><span class="linenos">56</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre.allocateDrones-57"><a href="#ControlCentre.allocateDrones-57"><span class="linenos">57</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.allocateDrones-58"><a href="#ControlCentre.allocateDrones-58"><span class="linenos">58</span></a>                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-59"><a href="#ControlCentre.allocateDrones-59"><span class="linenos">59</span></a>                <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-60"><a href="#ControlCentre.allocateDrones-60"><span class="linenos">60</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre.allocateDrones-61"><a href="#ControlCentre.allocateDrones-61"><span class="linenos">61</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-62"><a href="#ControlCentre.allocateDrones-62"><span class="linenos">62</span></a>                <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="ControlCentre.allocateDrones-63"><a href="#ControlCentre.allocateDrones-63"><span class="linenos">63</span></a>                <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-64"><a href="#ControlCentre.allocateDrones-64"><span class="linenos">64</span></a>                    <span class="k">break</span>
</span><span id="ControlCentre.allocateDrones-65"><a href="#ControlCentre.allocateDrones-65"><span class="linenos">65</span></a>
</span><span id="ControlCentre.allocateDrones-66"><a href="#ControlCentre.allocateDrones-66"><span class="linenos">66</span></a>        <span class="k">elif</span> <span class="n">ld</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># need to find drone nearest the ev before we allocate</span>
</span><span id="ControlCentre.allocateDrones-67"><a href="#ControlCentre.allocateDrones-67"><span class="linenos">67</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre.allocateDrones-68"><a href="#ControlCentre.allocateDrones-68"><span class="linenos">68</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.allocateDrones-69"><a href="#ControlCentre.allocateDrones-69"><span class="linenos">69</span></a>                <span class="n">nearestDrone</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ControlCentre.allocateDrones-70"><a href="#ControlCentre.allocateDrones-70"><span class="linenos">70</span></a>                <span class="n">evDistance</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
</span><span id="ControlCentre.allocateDrones-71"><a href="#ControlCentre.allocateDrones-71"><span class="linenos">71</span></a>                <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-72"><a href="#ControlCentre.allocateDrones-72"><span class="linenos">72</span></a>                    <span class="n">dronePos</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.allocateDrones-73"><a href="#ControlCentre.allocateDrones-73"><span class="linenos">73</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">dronePos</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-74"><a href="#ControlCentre.allocateDrones-74"><span class="linenos">74</span></a>                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">evDistance</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-75"><a href="#ControlCentre.allocateDrones-75"><span class="linenos">75</span></a>                        <span class="n">nearestDrone</span> <span class="o">=</span> <span class="n">drone</span>
</span><span id="ControlCentre.allocateDrones-76"><a href="#ControlCentre.allocateDrones-76"><span class="linenos">76</span></a>                        <span class="n">evDistance</span> <span class="o">=</span> <span class="n">distance</span>
</span><span id="ControlCentre.allocateDrones-77"><a href="#ControlCentre.allocateDrones-77"><span class="linenos">77</span></a>                <span class="k">if</span> <span class="n">nearestDrone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-78"><a href="#ControlCentre.allocateDrones-78"><span class="linenos">78</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">nearestDrone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-79"><a href="#ControlCentre.allocateDrones-79"><span class="linenos">79</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nearestDrone</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-80"><a href="#ControlCentre.allocateDrones-80"><span class="linenos">80</span></a>                <span class="k">elif</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-81"><a href="#ControlCentre.allocateDrones-81"><span class="linenos">81</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-82"><a href="#ControlCentre.allocateDrones-82"><span class="linenos">82</span></a>                    <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-83"><a href="#ControlCentre.allocateDrones-83"><span class="linenos">83</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre.allocateDrones-84"><a href="#ControlCentre.allocateDrones-84"><span class="linenos">84</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-85"><a href="#ControlCentre.allocateDrones-85"><span class="linenos">85</span></a>                    <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="ControlCentre.allocateDrones-86"><a href="#ControlCentre.allocateDrones-86"><span class="linenos">86</span></a>                    <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-87"><a href="#ControlCentre.allocateDrones-87"><span class="linenos">87</span></a>                        <span class="k">break</span>
</span><span id="ControlCentre.allocateDrones-88"><a href="#ControlCentre.allocateDrones-88"><span class="linenos">88</span></a>
</span><span id="ControlCentre.allocateDrones-89"><a href="#ControlCentre.allocateDrones-89"><span class="linenos">89</span></a>        <span class="k">else</span><span class="p">:</span>   <span class="c1"># ld == 0 nd &gt;0</span>
</span><span id="ControlCentre.allocateDrones-90"><a href="#ControlCentre.allocateDrones-90"><span class="linenos">90</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">urgencyList</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="ControlCentre.allocateDrones-91"><a href="#ControlCentre.allocateDrones-91"><span class="linenos">91</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.allocateDrones-92"><a href="#ControlCentre.allocateDrones-92"><span class="linenos">92</span></a>                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">nearestHubLocation</span><span class="p">(</span><span class="n">evPos</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-93"><a href="#ControlCentre.allocateDrones-93"><span class="linenos">93</span></a>                <span class="n">drone</span> <span class="o">=</span> <span class="n">Drone</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-94"><a href="#ControlCentre.allocateDrones-94"><span class="linenos">94</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre.allocateDrones-95"><a href="#ControlCentre.allocateDrones-95"><span class="linenos">95</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">drone</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
</span><span id="ControlCentre.allocateDrones-96"><a href="#ControlCentre.allocateDrones-96"><span class="linenos">96</span></a>                <span class="n">nd</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="ControlCentre.allocateDrones-97"><a href="#ControlCentre.allocateDrones-97"><span class="linenos">97</span></a>                <span class="k">if</span> <span class="n">nd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.allocateDrones-98"><a href="#ControlCentre.allocateDrones-98"><span class="linenos">98</span></a>                    <span class="k">break</span>
</span></pre></div>


            <div class="docstring"><p>Allocate whatever drones we have free/viable in order of urgency,
if more than one drone available assign the nearest</p>
</div>


                            </div>
                            <div id="ControlCentre.calcUrgency" class="classattr">
                                        <input id="ControlCentre.calcUrgency-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcUrgency</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.calcUrgency-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.calcUrgency"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.calcUrgency-100"><a href="#ControlCentre.calcUrgency-100"><span class="linenos">100</span></a>    <span class="k">def</span> <span class="nf">calcUrgency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre.calcUrgency-101"><a href="#ControlCentre.calcUrgency-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;urgency defined as distance to nearest hub/distance ev can travel on charge.</span>
</span><span id="ControlCentre.calcUrgency-102"><a href="#ControlCentre.calcUrgency-102"><span class="linenos">102</span></a><span class="sd">            creates a list of ev&#39;s that want charge, have not been allocated a drone</span>
</span><span id="ControlCentre.calcUrgency-103"><a href="#ControlCentre.calcUrgency-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre.calcUrgency-104"><a href="#ControlCentre.calcUrgency-104"><span class="linenos">104</span></a>        <span class="n">urgencyList</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ControlCentre.calcUrgency-105"><a href="#ControlCentre.calcUrgency-105"><span class="linenos">105</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-106"><a href="#ControlCentre.calcUrgency-106"><span class="linenos">106</span></a>          <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-107"><a href="#ControlCentre.calcUrgency-107"><span class="linenos">107</span></a>            <span class="n">urgencyList</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ControlCentre.calcUrgency-108"><a href="#ControlCentre.calcUrgency-108"><span class="linenos">108</span></a>
</span><span id="ControlCentre.calcUrgency-109"><a href="#ControlCentre.calcUrgency-109"><span class="linenos">109</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-110"><a href="#ControlCentre.calcUrgency-110"><span class="linenos">110</span></a>            <span class="n">firstCall</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ControlCentre.calcUrgency-111"><a href="#ControlCentre.calcUrgency-111"><span class="linenos">111</span></a>            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-112"><a href="#ControlCentre.calcUrgency-112"><span class="linenos">112</span></a>                <span class="c1"># note drivingDistance can be very large -  float max if there is no hub on the remaining route</span>
</span><span id="ControlCentre.calcUrgency-113"><a href="#ControlCentre.calcUrgency-113"><span class="linenos">113</span></a>                <span class="n">evID</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
</span><span id="ControlCentre.calcUrgency-114"><a href="#ControlCentre.calcUrgency-114"><span class="linenos">114</span></a>                <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-115"><a href="#ControlCentre.calcUrgency-115"><span class="linenos">115</span></a>                    <span class="n">ev</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.calcUrgency-116"><a href="#ControlCentre.calcUrgency-116"><span class="linenos">116</span></a>                <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.calcUrgency-117"><a href="#ControlCentre.calcUrgency-117"><span class="linenos">117</span></a>
</span><span id="ControlCentre.calcUrgency-118"><a href="#ControlCentre.calcUrgency-118"><span class="linenos">118</span></a>                <span class="n">hub</span><span class="p">,</span> <span class="n">hubDistance</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ch</span><span class="o">.</span><span class="n">findNearestHub</span><span class="p">(</span><span class="n">evPos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evPos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ControlCentre.calcUrgency-119"><a href="#ControlCentre.calcUrgency-119"><span class="linenos">119</span></a>                <span class="c1"># hub, hubDistance = GG.ch.findNearestHubDriving(evID)</span>
</span><span id="ControlCentre.calcUrgency-120"><a href="#ControlCentre.calcUrgency-120"><span class="linenos">120</span></a>                <span class="n">evRange</span> <span class="o">=</span> <span class="mf">200.0</span>
</span><span id="ControlCentre.calcUrgency-121"><a href="#ControlCentre.calcUrgency-121"><span class="linenos">121</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># if we have an ugency weight then we need to calculate the range</span>
</span><span id="ControlCentre.calcUrgency-122"><a href="#ControlCentre.calcUrgency-122"><span class="linenos">122</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getDistance</span><span class="p">(</span><span class="n">evID</span><span class="p">))</span>
</span><span id="ControlCentre.calcUrgency-123"><a href="#ControlCentre.calcUrgency-123"><span class="linenos">123</span></a>                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>  <span class="c1"># can compute real range after we&#39;ve been driving for a while - arbitrary 10km</span>
</span><span id="ControlCentre.calcUrgency-124"><a href="#ControlCentre.calcUrgency-124"><span class="linenos">124</span></a>                        <span class="n">mWh</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.totalEnergyConsumed&quot;</span><span class="p">))</span>
</span><span id="ControlCentre.calcUrgency-125"><a href="#ControlCentre.calcUrgency-125"><span class="linenos">125</span></a>                        <span class="n">evRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.actualBatteryCapacity&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">mWh</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.calcUrgency-126"><a href="#ControlCentre.calcUrgency-126"><span class="linenos">126</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1">#  otherwise just a guesstimate</span>
</span><span id="ControlCentre.calcUrgency-127"><a href="#ControlCentre.calcUrgency-127"><span class="linenos">127</span></a>                        <span class="n">evRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="s2">&quot;device.battery.actualBatteryCapacity&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyKmPerWh</span><span class="p">()</span>
</span><span id="ControlCentre.calcUrgency-128"><a href="#ControlCentre.calcUrgency-128"><span class="linenos">128</span></a>
</span><span id="ControlCentre.calcUrgency-129"><a href="#ControlCentre.calcUrgency-129"><span class="linenos">129</span></a>                <span class="n">proximity</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ControlCentre.calcUrgency-130"><a href="#ControlCentre.calcUrgency-130"><span class="linenos">130</span></a>                <span class="n">urgency</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="ControlCentre.calcUrgency-131"><a href="#ControlCentre.calcUrgency-131"><span class="linenos">131</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>            <span class="c1"># We have a weight so need to calculate proximity</span>
</span><span id="ControlCentre.calcUrgency-132"><a href="#ControlCentre.calcUrgency-132"><span class="linenos">132</span></a>                    <span class="n">neighbours</span><span class="p">,</span> <span class="n">meanDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNeighboursNeedingCharge</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">firstCall</span><span class="p">)</span>
</span><span id="ControlCentre.calcUrgency-133"><a href="#ControlCentre.calcUrgency-133"><span class="linenos">133</span></a>                    <span class="n">firstCall</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ControlCentre.calcUrgency-134"><a href="#ControlCentre.calcUrgency-134"><span class="linenos">134</span></a>
</span><span id="ControlCentre.calcUrgency-135"><a href="#ControlCentre.calcUrgency-135"><span class="linenos">135</span></a>                    <span class="c1"># find distance for nearest drone to this eV - usually only one drone so will be the one allocated</span>
</span><span id="ControlCentre.calcUrgency-136"><a href="#ControlCentre.calcUrgency-136"><span class="linenos">136</span></a>                    <span class="n">droneDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span>    <span class="c1"># default - should never happen - otherwise fn wouldn&#39;t be called</span>
</span><span id="ControlCentre.calcUrgency-137"><a href="#ControlCentre.calcUrgency-137"><span class="linenos">137</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-138"><a href="#ControlCentre.calcUrgency-138"><span class="linenos">138</span></a>                        <span class="n">droneDist</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
</span><span id="ControlCentre.calcUrgency-139"><a href="#ControlCentre.calcUrgency-139"><span class="linenos">139</span></a>                        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-140"><a href="#ControlCentre.calcUrgency-140"><span class="linenos">140</span></a>                            <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">())</span>
</span><span id="ControlCentre.calcUrgency-141"><a href="#ControlCentre.calcUrgency-141"><span class="linenos">141</span></a>                            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">droneDist</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-142"><a href="#ControlCentre.calcUrgency-142"><span class="linenos">142</span></a>                                <span class="n">droneDist</span> <span class="o">=</span> <span class="n">dist</span>
</span><span id="ControlCentre.calcUrgency-143"><a href="#ControlCentre.calcUrgency-143"><span class="linenos">143</span></a>
</span><span id="ControlCentre.calcUrgency-144"><a href="#ControlCentre.calcUrgency-144"><span class="linenos">144</span></a>                    <span class="c1"># proximity factors - smallest value is most important = &#39;nearest</span>
</span><span id="ControlCentre.calcUrgency-145"><a href="#ControlCentre.calcUrgency-145"><span class="linenos">145</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-146"><a href="#ControlCentre.calcUrgency-146"><span class="linenos">146</span></a>                        <span class="n">meanDist</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>   <span class="c1"># set distance  &#39;smaller&#39; the more neighbours there are</span>
</span><span id="ControlCentre.calcUrgency-147"><a href="#ControlCentre.calcUrgency-147"><span class="linenos">147</span></a>                    <span class="k">del</span> <span class="n">neighbours</span>
</span><span id="ControlCentre.calcUrgency-148"><a href="#ControlCentre.calcUrgency-148"><span class="linenos">148</span></a>
</span><span id="ControlCentre.calcUrgency-149"><a href="#ControlCentre.calcUrgency-149"><span class="linenos">149</span></a>                    <span class="c1"># add in drone distance - ie smallest proximity will have closest drone</span>
</span><span id="ControlCentre.calcUrgency-150"><a href="#ControlCentre.calcUrgency-150"><span class="linenos">150</span></a>                    <span class="k">if</span> <span class="n">hubDistance</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-151"><a href="#ControlCentre.calcUrgency-151"><span class="linenos">151</span></a>                       <span class="n">proximity</span> <span class="o">=</span> <span class="n">droneDist</span> <span class="o">+</span> <span class="n">meanDist</span>  <span class="c1"># + evRange</span>
</span><span id="ControlCentre.calcUrgency-152"><a href="#ControlCentre.calcUrgency-152"><span class="linenos">152</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-153"><a href="#ControlCentre.calcUrgency-153"><span class="linenos">153</span></a>                       <span class="n">proximity</span> <span class="o">=</span> <span class="n">droneDist</span> <span class="o">+</span> <span class="n">meanDist</span>  <span class="c1"># / drivingDistance</span>
</span><span id="ControlCentre.calcUrgency-154"><a href="#ControlCentre.calcUrgency-154"><span class="linenos">154</span></a>
</span><span id="ControlCentre.calcUrgency-155"><a href="#ControlCentre.calcUrgency-155"><span class="linenos">155</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.calcUrgency-156"><a href="#ControlCentre.calcUrgency-156"><span class="linenos">156</span></a>                    <span class="n">urgency</span> <span class="o">=</span> <span class="n">hubDistance</span><span class="o">/</span><span class="n">evRange</span>
</span><span id="ControlCentre.calcUrgency-157"><a href="#ControlCentre.calcUrgency-157"><span class="linenos">157</span></a>
</span><span id="ControlCentre.calcUrgency-158"><a href="#ControlCentre.calcUrgency-158"><span class="linenos">158</span></a>                <span class="n">CEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">proximity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">urgency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">)</span>
</span><span id="ControlCentre.calcUrgency-159"><a href="#ControlCentre.calcUrgency-159"><span class="linenos">159</span></a>                <span class="n">urgencyList</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">CEC</span>
</span><span id="ControlCentre.calcUrgency-160"><a href="#ControlCentre.calcUrgency-160"><span class="linenos">160</span></a>
</span><span id="ControlCentre.calcUrgency-161"><a href="#ControlCentre.calcUrgency-161"><span class="linenos">161</span></a>        <span class="k">return</span> <span class="n">urgencyList</span>
</span></pre></div>


            <div class="docstring"><p>urgency defined as distance to nearest hub/distance ev can travel on charge.
creates a list of ev's that want charge, have not been allocated a drone</p>
</div>


                            </div>
                            <div id="ControlCentre.findEdgePos" class="classattr">
                                        <input id="ControlCentre.findEdgePos-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">findEdgePos</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">evID</span>, </span><span class="param"><span class="n">deltaPos</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.findEdgePos-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.findEdgePos"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.findEdgePos-163"><a href="#ControlCentre.findEdgePos-163"><span class="linenos">163</span></a>    <span class="k">def</span> <span class="nf">findEdgePos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evID</span><span class="p">,</span> <span class="n">deltaPos</span><span class="p">):</span>
</span><span id="ControlCentre.findEdgePos-164"><a href="#ControlCentre.findEdgePos-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;work out the edge and position of the EV, when it is deltaPos metres along the route from the current position</span>
</span><span id="ControlCentre.findEdgePos-165"><a href="#ControlCentre.findEdgePos-165"><span class="linenos">165</span></a><span class="sd">            to give us an approximation to the rendezvous position</span>
</span><span id="ControlCentre.findEdgePos-166"><a href="#ControlCentre.findEdgePos-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre.findEdgePos-167"><a href="#ControlCentre.findEdgePos-167"><span class="linenos">167</span></a>        <span class="n">jnDelta</span> <span class="o">=</span> <span class="mi">150</span>          <span class="c1"># no of travel metres &#39;lost&#39; by vehicle crossing a junction, found by testing against random grid  (ie allowance for vehicle slowing/accelerating)</span>
</span><span id="ControlCentre.findEdgePos-168"><a href="#ControlCentre.findEdgePos-168"><span class="linenos">168</span></a>        <span class="c1"># find route and position of vehicle along the route - (this will always give us an edge)</span>
</span><span id="ControlCentre.findEdgePos-169"><a href="#ControlCentre.findEdgePos-169"><span class="linenos">169</span></a>        <span class="n">evRoute</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRoute</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-170"><a href="#ControlCentre.findEdgePos-170"><span class="linenos">170</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRouteIndex</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-171"><a href="#ControlCentre.findEdgePos-171"><span class="linenos">171</span></a>        <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ControlCentre.findEdgePos-172"><a href="#ControlCentre.findEdgePos-172"><span class="linenos">172</span></a>        <span class="n">lanePosition</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getLanePosition</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-173"><a href="#ControlCentre.findEdgePos-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="n">deltaPos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.findEdgePos-174"><a href="#ControlCentre.findEdgePos-174"><span class="linenos">174</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;oops invalid call to findEdgePos:&quot;</span><span class="p">,</span> <span class="n">deltaPos</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-175"><a href="#ControlCentre.findEdgePos-175"><span class="linenos">175</span></a>            <span class="n">deltaPos</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre.findEdgePos-176"><a href="#ControlCentre.findEdgePos-176"><span class="linenos">176</span></a>        <span class="c1"># whilst we have the edge from above the vehicle could actually be on a junction which messes up the edge to edge calculation</span>
</span><span id="ControlCentre.findEdgePos-177"><a href="#ControlCentre.findEdgePos-177"><span class="linenos">177</span></a>        <span class="c1"># so we get current road ID which can be a junction and if it is then skip along the route to the next edge</span>
</span><span id="ControlCentre.findEdgePos-178"><a href="#ControlCentre.findEdgePos-178"><span class="linenos">178</span></a>        <span class="n">road</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getRoadID</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-179"><a href="#ControlCentre.findEdgePos-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="n">road</span> <span class="o">!=</span> <span class="n">edge</span><span class="p">:</span>       <span class="c1"># ev is on a junction, set to start of next edge</span>
</span><span id="ControlCentre.findEdgePos-180"><a href="#ControlCentre.findEdgePos-180"><span class="linenos">180</span></a>          <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre.findEdgePos-181"><a href="#ControlCentre.findEdgePos-181"><span class="linenos">181</span></a>          <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ControlCentre.findEdgePos-182"><a href="#ControlCentre.findEdgePos-182"><span class="linenos">182</span></a>          <span class="n">lanePosition</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre.findEdgePos-183"><a href="#ControlCentre.findEdgePos-183"><span class="linenos">183</span></a>
</span><span id="ControlCentre.findEdgePos-184"><a href="#ControlCentre.findEdgePos-184"><span class="linenos">184</span></a>        <span class="c1"># &#39;travel&#39; along edges on route until we&#39;ve gone  deltaPos metres</span>
</span><span id="ControlCentre.findEdgePos-185"><a href="#ControlCentre.findEdgePos-185"><span class="linenos">185</span></a>        <span class="n">newEVPosition</span> <span class="o">=</span> <span class="n">lanePosition</span> <span class="o">+</span> <span class="n">deltaPos</span>
</span><span id="ControlCentre.findEdgePos-186"><a href="#ControlCentre.findEdgePos-186"><span class="linenos">186</span></a>        <span class="n">laneLength</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">lane</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="n">edge</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-187"><a href="#ControlCentre.findEdgePos-187"><span class="linenos">187</span></a>        <span class="k">while</span> <span class="n">newEVPosition</span> <span class="o">&gt;</span> <span class="n">laneLength</span> <span class="o">+</span> <span class="n">jnDelta</span><span class="p">:</span>
</span><span id="ControlCentre.findEdgePos-188"><a href="#ControlCentre.findEdgePos-188"><span class="linenos">188</span></a>            <span class="n">newEVPosition</span> <span class="o">-=</span> <span class="p">(</span><span class="n">laneLength</span> <span class="o">+</span> <span class="n">jnDelta</span><span class="p">)</span>    <span class="c1"># subtract jnDelta as the penalty in distance travelled, in the total travel time, for each junction</span>
</span><span id="ControlCentre.findEdgePos-189"><a href="#ControlCentre.findEdgePos-189"><span class="linenos">189</span></a>            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ControlCentre.findEdgePos-190"><a href="#ControlCentre.findEdgePos-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evRoute</span><span class="p">):</span>                 <span class="c1"># rv point is after end of route - so we can&#39;t charge</span>
</span><span id="ControlCentre.findEdgePos-191"><a href="#ControlCentre.findEdgePos-191"><span class="linenos">191</span></a>                <span class="k">return</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">laneLength</span><span class="p">,</span> <span class="kc">False</span>   <span class="c1"># set to end of route</span>
</span><span id="ControlCentre.findEdgePos-192"><a href="#ControlCentre.findEdgePos-192"><span class="linenos">192</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="n">evRoute</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="ControlCentre.findEdgePos-193"><a href="#ControlCentre.findEdgePos-193"><span class="linenos">193</span></a>            <span class="n">laneLength</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">lane</span><span class="o">.</span><span class="n">getLength</span><span class="p">(</span><span class="n">edge</span> <span class="o">+</span> <span class="s1">&#39;_0&#39;</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-194"><a href="#ControlCentre.findEdgePos-194"><span class="linenos">194</span></a>
</span><span id="ControlCentre.findEdgePos-195"><a href="#ControlCentre.findEdgePos-195"><span class="linenos">195</span></a>        <span class="n">newEVPosition</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newEVPosition</span><span class="p">,</span> <span class="n">laneLength</span><span class="p">)</span>
</span><span id="ControlCentre.findEdgePos-196"><a href="#ControlCentre.findEdgePos-196"><span class="linenos">196</span></a>
</span><span id="ControlCentre.findEdgePos-197"><a href="#ControlCentre.findEdgePos-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="n">edge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">,</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>work out the edge and position of the EV, when it is deltaPos metres along the route from the current position
to give us an approximation to the rendezvous position</p>
</div>


                            </div>
                            <div id="ControlCentre.findRendezvousXY" class="classattr">
                                        <input id="ControlCentre.findRendezvousXY-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">findRendezvousXY</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ev</span>, </span><span class="param"><span class="n">drone</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.findRendezvousXY-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.findRendezvousXY"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.findRendezvousXY-199"><a href="#ControlCentre.findRendezvousXY-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">findRendezvousXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">drone</span><span class="p">):</span>
</span><span id="ControlCentre.findRendezvousXY-200"><a href="#ControlCentre.findRendezvousXY-200"><span class="linenos">200</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;estimate a direct rendezvous point for the drone/vehicle - assumes constant vehicle speed</span>
</span><span id="ControlCentre.findRendezvousXY-201"><a href="#ControlCentre.findRendezvousXY-201"><span class="linenos">201</span></a><span class="sd">              apply a factor of 90% to allow for acceleration/deceleration/% of time not at allowed speed</span>
</span><span id="ControlCentre.findRendezvousXY-202"><a href="#ControlCentre.findRendezvousXY-202"><span class="linenos">202</span></a><span class="sd">           algorithm from https://www.codeproject.com/Articles/990452/Interception-of-Two-Moving-Objects-in-D-Space</span>
</span><span id="ControlCentre.findRendezvousXY-203"><a href="#ControlCentre.findRendezvousXY-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre.findRendezvousXY-204"><a href="#ControlCentre.findRendezvousXY-204"><span class="linenos">204</span></a>        <span class="n">evID</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>         <span class="c1"># needed for Traci calls</span>
</span><span id="ControlCentre.findRendezvousXY-205"><a href="#ControlCentre.findRendezvousXY-205"><span class="linenos">205</span></a>        <span class="c1"># assume speed on current edge is that for subsequent edges</span>
</span><span id="ControlCentre.findRendezvousXY-206"><a href="#ControlCentre.findRendezvousXY-206"><span class="linenos">206</span></a>        <span class="n">evSpeed</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">traci</span><span class="o">.</span><span class="n">vehicle</span><span class="o">.</span><span class="n">getAllowedSpeed</span><span class="p">(</span><span class="n">evID</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-207"><a href="#ControlCentre.findRendezvousXY-207"><span class="linenos">207</span></a>
</span><span id="ControlCentre.findRendezvousXY-208"><a href="#ControlCentre.findRendezvousXY-208"><span class="linenos">208</span></a>        <span class="c1"># work out how long it takes drone to fly to ev</span>
</span><span id="ControlCentre.findRendezvousXY-209"><a href="#ControlCentre.findRendezvousXY-209"><span class="linenos">209</span></a>        <span class="n">posEV</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.findRendezvousXY-210"><a href="#ControlCentre.findRendezvousXY-210"><span class="linenos">210</span></a>        <span class="n">posDrone</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.findRendezvousXY-211"><a href="#ControlCentre.findRendezvousXY-211"><span class="linenos">211</span></a>        <span class="n">distanceToEV</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">posDrone</span><span class="p">,</span> <span class="n">posEV</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-212"><a href="#ControlCentre.findRendezvousXY-212"><span class="linenos">212</span></a>        <span class="n">crowFlies</span> <span class="o">=</span> <span class="n">distanceToEV</span><span class="o">/</span><span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneMperSec</span>
</span><span id="ControlCentre.findRendezvousXY-213"><a href="#ControlCentre.findRendezvousXY-213"><span class="linenos">213</span></a>        <span class="c1"># how far vehicle can travel in same time</span>
</span><span id="ControlCentre.findRendezvousXY-214"><a href="#ControlCentre.findRendezvousXY-214"><span class="linenos">214</span></a>        <span class="n">evCrowFlies</span> <span class="o">=</span> <span class="n">evSpeed</span> <span class="o">*</span> <span class="n">crowFlies</span>
</span><span id="ControlCentre.findRendezvousXY-215"><a href="#ControlCentre.findRendezvousXY-215"><span class="linenos">215</span></a>        <span class="c1"># where on the road that distance is</span>
</span><span id="ControlCentre.findRendezvousXY-216"><a href="#ControlCentre.findRendezvousXY-216"><span class="linenos">216</span></a>        <span class="n">vEdge</span><span class="p">,</span> <span class="n">vPos</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findEdgePos</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="n">evCrowFlies</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-217"><a href="#ControlCentre.findRendezvousXY-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
</span><span id="ControlCentre.findRendezvousXY-218"><a href="#ControlCentre.findRendezvousXY-218"><span class="linenos">218</span></a>            <span class="n">posRV</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">convert2D</span><span class="p">(</span><span class="n">vEdge</span><span class="p">,</span> <span class="n">vPos</span><span class="p">)</span>        <span class="c1"># get the x, y position after evCrowFlies metres</span>
</span><span id="ControlCentre.findRendezvousXY-219"><a href="#ControlCentre.findRendezvousXY-219"><span class="linenos">219</span></a>            <span class="c1"># compute the velocity vector</span>
</span><span id="ControlCentre.findRendezvousXY-220"><a href="#ControlCentre.findRendezvousXY-220"><span class="linenos">220</span></a>            <span class="n">evV</span> <span class="o">=</span> <span class="p">(</span><span class="n">posRV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">crowFlies</span><span class="p">,</span> <span class="p">(</span><span class="n">posRV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">crowFlies</span>
</span><span id="ControlCentre.findRendezvousXY-221"><a href="#ControlCentre.findRendezvousXY-221"><span class="linenos">221</span></a>
</span><span id="ControlCentre.findRendezvousXY-222"><a href="#ControlCentre.findRendezvousXY-222"><span class="linenos">222</span></a>            <span class="n">vectorFromEV</span> <span class="o">=</span> <span class="n">posDrone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posDrone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">posEV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ControlCentre.findRendezvousXY-223"><a href="#ControlCentre.findRendezvousXY-223"><span class="linenos">223</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneMperSec</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">pow</span><span class="p">(</span><span class="n">evSpeed</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-224"><a href="#ControlCentre.findRendezvousXY-224"><span class="linenos">224</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vectorFromEV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">evV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vectorFromEV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">evV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ControlCentre.findRendezvousXY-225"><a href="#ControlCentre.findRendezvousXY-225"><span class="linenos">225</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">distanceToEV</span> <span class="o">*</span> <span class="n">distanceToEV</span>
</span><span id="ControlCentre.findRendezvousXY-226"><a href="#ControlCentre.findRendezvousXY-226"><span class="linenos">226</span></a>            <span class="n">bb4ac</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-227"><a href="#ControlCentre.findRendezvousXY-227"><span class="linenos">227</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bb4ac</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-228"><a href="#ControlCentre.findRendezvousXY-228"><span class="linenos">228</span></a>            <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bb4ac</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-229"><a href="#ControlCentre.findRendezvousXY-229"><span class="linenos">229</span></a>
</span><span id="ControlCentre.findRendezvousXY-230"><a href="#ControlCentre.findRendezvousXY-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="n">t1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># no solution we can&#39;t meet the EV</span>
</span><span id="ControlCentre.findRendezvousXY-231"><a href="#ControlCentre.findRendezvousXY-231"><span class="linenos">231</span></a>                <span class="k">return</span> <span class="n">posDrone</span>
</span><span id="ControlCentre.findRendezvousXY-232"><a href="#ControlCentre.findRendezvousXY-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">t1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># both positive take the smallest</span>
</span><span id="ControlCentre.findRendezvousXY-233"><a href="#ControlCentre.findRendezvousXY-233"><span class="linenos">233</span></a>                <span class="n">interceptDistance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">evSpeed</span>
</span><span id="ControlCentre.findRendezvousXY-234"><a href="#ControlCentre.findRendezvousXY-234"><span class="linenos">234</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># one is -ve so take the maximum</span>
</span><span id="ControlCentre.findRendezvousXY-235"><a href="#ControlCentre.findRendezvousXY-235"><span class="linenos">235</span></a>                <span class="n">interceptDistance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">*</span> <span class="n">evSpeed</span>
</span><span id="ControlCentre.findRendezvousXY-236"><a href="#ControlCentre.findRendezvousXY-236"><span class="linenos">236</span></a>
</span><span id="ControlCentre.findRendezvousXY-237"><a href="#ControlCentre.findRendezvousXY-237"><span class="linenos">237</span></a>            <span class="n">rendezvousEdge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findEdgePos</span><span class="p">(</span><span class="n">evID</span><span class="p">,</span> <span class="n">interceptDistance</span><span class="p">)</span>
</span><span id="ControlCentre.findRendezvousXY-238"><a href="#ControlCentre.findRendezvousXY-238"><span class="linenos">238</span></a>            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>       <span class="c1"># will normally only fail if drone cannot reach EV under straight line intercept assumptions</span>
</span><span id="ControlCentre.findRendezvousXY-239"><a href="#ControlCentre.findRendezvousXY-239"><span class="linenos">239</span></a>                <span class="n">posRV</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">convert2D</span><span class="p">(</span><span class="n">rendezvousEdge</span><span class="p">,</span> <span class="n">newEVPosition</span><span class="p">)</span>      <span class="c1"># get the x, y position after evCrowFlies metres</span>
</span><span id="ControlCentre.findRendezvousXY-240"><a href="#ControlCentre.findRendezvousXY-240"><span class="linenos">240</span></a>                <span class="c1"># Algorithm debug lines - show rendezvous point</span>
</span><span id="ControlCentre.findRendezvousXY-241"><a href="#ControlCentre.findRendezvousXY-241"><span class="linenos">241</span></a>                <span class="c1"># pid = ev + &quot; &quot; + str(timeStep)</span>
</span><span id="ControlCentre.findRendezvousXY-242"><a href="#ControlCentre.findRendezvousXY-242"><span class="linenos">242</span></a>                <span class="c1"># traci.poi.add(pid, posRV[0], posRV[1], color=(255, 0, 255), layer=250, imgFile=&quot;.\\PNG132.bmp&quot;, width=5, height=5)</span>
</span><span id="ControlCentre.findRendezvousXY-243"><a href="#ControlCentre.findRendezvousXY-243"><span class="linenos">243</span></a>            <span class="k">return</span> <span class="n">posRV</span>   <span class="c1"># this falls back to the original crow flies when straight line intercept fails</span>
</span><span id="ControlCentre.findRendezvousXY-244"><a href="#ControlCentre.findRendezvousXY-244"><span class="linenos">244</span></a>
</span><span id="ControlCentre.findRendezvousXY-245"><a href="#ControlCentre.findRendezvousXY-245"><span class="linenos">245</span></a>        <span class="c1"># print(timeStep, ev, drone, evCrowFlies, &quot;fail 2&quot;)  &#39;fail&#39; usually because vehicle has left simulation</span>
</span><span id="ControlCentre.findRendezvousXY-246"><a href="#ControlCentre.findRendezvousXY-246"><span class="linenos">246</span></a>        <span class="k">return</span> <span class="n">posDrone</span>   <span class="c1"># revert to direct intercept</span>
</span></pre></div>


            <div class="docstring"><p>estimate a direct rendezvous point for the drone/vehicle - assumes constant vehicle speed
   apply a factor of 90% to allow for acceleration/deceleration/% of time not at allowed speed
algorithm from <a href="https://www.codeproject.com/Articles/990452/Interception-of-Two-Moving-Objects-in-D-Space">https://www.codeproject.com/Articles/990452/Interception-of-Two-Moving-Objects-in-D-Space</a></p>
</div>


                            </div>
                            <div id="ControlCentre.getNeighboursNeedingCharge" class="classattr">
                                        <input id="ControlCentre.getNeighboursNeedingCharge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getNeighboursNeedingCharge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ev</span>, </span><span class="param"><span class="n">firstCall</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.getNeighboursNeedingCharge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.getNeighboursNeedingCharge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.getNeighboursNeedingCharge-248"><a href="#ControlCentre.getNeighboursNeedingCharge-248"><span class="linenos">248</span></a>    <span class="k">def</span> <span class="nf">getNeighboursNeedingCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">firstCall</span><span class="p">):</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-249"><a href="#ControlCentre.getNeighboursNeedingCharge-249"><span class="linenos">249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;find all the ev&#39;s that are requesting a charge and compute the mean distance to these</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-250"><a href="#ControlCentre.getNeighboursNeedingCharge-250"><span class="linenos">250</span></a><span class="sd">              note calling math.dist which will use sqrt is actually faster than comparing distances to the square</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-251"><a href="#ControlCentre.getNeighboursNeedingCharge-251"><span class="linenos">251</span></a><span class="sd">              we only update the ev positions on first call because we will repeat call to this fn for each ev in creating urgency list</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-252"><a href="#ControlCentre.getNeighboursNeedingCharge-252"><span class="linenos">252</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-253"><a href="#ControlCentre.getNeighboursNeedingCharge-253"><span class="linenos">253</span></a>        <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-254"><a href="#ControlCentre.getNeighboursNeedingCharge-254"><span class="linenos">254</span></a>        <span class="n">meanDist</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-255"><a href="#ControlCentre.getNeighboursNeedingCharge-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-256"><a href="#ControlCentre.getNeighboursNeedingCharge-256"><span class="linenos">256</span></a>            <span class="n">ev</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-257"><a href="#ControlCentre.getNeighboursNeedingCharge-257"><span class="linenos">257</span></a>        <span class="n">evPos</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-258"><a href="#ControlCentre.getNeighboursNeedingCharge-258"><span class="linenos">258</span></a>
</span><span id="ControlCentre.getNeighboursNeedingCharge-259"><a href="#ControlCentre.getNeighboursNeedingCharge-259"><span class="linenos">259</span></a>        <span class="k">for</span> <span class="n">nEV</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-260"><a href="#ControlCentre.getNeighboursNeedingCharge-260"><span class="linenos">260</span></a>            <span class="k">if</span> <span class="n">nEV</span> <span class="o">==</span> <span class="n">ev</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-261"><a href="#ControlCentre.getNeighboursNeedingCharge-261"><span class="linenos">261</span></a>                <span class="k">continue</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-262"><a href="#ControlCentre.getNeighboursNeedingCharge-262"><span class="linenos">262</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-263"><a href="#ControlCentre.getNeighboursNeedingCharge-263"><span class="linenos">263</span></a>                <span class="k">if</span> <span class="n">firstCall</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-264"><a href="#ControlCentre.getNeighboursNeedingCharge-264"><span class="linenos">264</span></a>                    <span class="n">nEV</span><span class="o">.</span><span class="n">setMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-265"><a href="#ControlCentre.getNeighboursNeedingCharge-265"><span class="linenos">265</span></a>                <span class="n">vPos</span> <span class="o">=</span> <span class="n">nEV</span><span class="o">.</span><span class="n">getMyPosition</span><span class="p">()</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-266"><a href="#ControlCentre.getNeighboursNeedingCharge-266"><span class="linenos">266</span></a>
</span><span id="ControlCentre.getNeighboursNeedingCharge-267"><a href="#ControlCentre.getNeighboursNeedingCharge-267"><span class="linenos">267</span></a>                <span class="n">xdist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">evPos</span><span class="p">,</span> <span class="n">vPos</span><span class="p">)</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-268"><a href="#ControlCentre.getNeighboursNeedingCharge-268"><span class="linenos">268</span></a>                <span class="k">if</span> <span class="n">xdist</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-269"><a href="#ControlCentre.getNeighboursNeedingCharge-269"><span class="linenos">269</span></a>                    <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nEV</span><span class="p">)</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-270"><a href="#ControlCentre.getNeighboursNeedingCharge-270"><span class="linenos">270</span></a>                    <span class="n">meanDist</span> <span class="o">+=</span> <span class="n">xdist</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-271"><a href="#ControlCentre.getNeighboursNeedingCharge-271"><span class="linenos">271</span></a>            <span class="k">except</span> <span class="n">traci</span><span class="o">.</span><span class="n">TraCIException</span><span class="p">:</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-272"><a href="#ControlCentre.getNeighboursNeedingCharge-272"><span class="linenos">272</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;neighbour exception:&quot;</span><span class="p">,</span> <span class="n">traci</span><span class="o">.</span><span class="n">TraCIException</span><span class="p">)</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-273"><a href="#ControlCentre.getNeighboursNeedingCharge-273"><span class="linenos">273</span></a>                <span class="k">continue</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-274"><a href="#ControlCentre.getNeighboursNeedingCharge-274"><span class="linenos">274</span></a>
</span><span id="ControlCentre.getNeighboursNeedingCharge-275"><a href="#ControlCentre.getNeighboursNeedingCharge-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="n">meanDist</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>                      <span class="c1"># we have at least 1 ev so calculate the actual mean distance</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-276"><a href="#ControlCentre.getNeighboursNeedingCharge-276"><span class="linenos">276</span></a>            <span class="n">meanDist</span> <span class="o">=</span> <span class="n">meanDist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
</span><span id="ControlCentre.getNeighboursNeedingCharge-277"><a href="#ControlCentre.getNeighboursNeedingCharge-277"><span class="linenos">277</span></a>        <span class="k">return</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">meanDist</span>
</span></pre></div>


            <div class="docstring"><p>find all the ev's that are requesting a charge and compute the mean distance to these
note calling math.dist which will use sqrt is actually faster than comparing distances to the square
we only update the ev positions on first call because we will repeat call to this fn for each ev in creating urgency list</p>
</div>


                            </div>
                            <div id="ControlCentre.notifyDroneState" class="classattr">
                                        <input id="ControlCentre.notifyDroneState-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">notifyDroneState</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">drone</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.notifyDroneState-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.notifyDroneState"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.notifyDroneState-279"><a href="#ControlCentre.notifyDroneState-279"><span class="linenos">279</span></a>    <span class="k">def</span> <span class="nf">notifyDroneState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drone</span><span class="p">):</span>
</span><span id="ControlCentre.notifyDroneState-280"><a href="#ControlCentre.notifyDroneState-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Notification from Drone when charging finished or Drone has broken off the charge/flight&quot;&quot;&quot;</span>
</span><span id="ControlCentre.notifyDroneState-281"><a href="#ControlCentre.notifyDroneState-281"><span class="linenos">281</span></a>        <span class="k">if</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">:</span>
</span><span id="ControlCentre.notifyDroneState-282"><a href="#ControlCentre.notifyDroneState-282"><span class="linenos">282</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]]</span>
</span><span id="ControlCentre.notifyDroneState-283"><a href="#ControlCentre.notifyDroneState-283"><span class="linenos">283</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="n">drone</span><span class="p">]</span>
</span><span id="ControlCentre.notifyDroneState-284"><a href="#ControlCentre.notifyDroneState-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">viable</span><span class="p">():</span>
</span><span id="ControlCentre.notifyDroneState-285"><a href="#ControlCentre.notifyDroneState-285"><span class="linenos">285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="ControlCentre.notifyDroneState-286"><a href="#ControlCentre.notifyDroneState-286"><span class="linenos">286</span></a>            <span class="k">if</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="ControlCentre.notifyDroneState-287"><a href="#ControlCentre.notifyDroneState-287"><span class="linenos">287</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span><span id="ControlCentre.notifyDroneState-288"><a href="#ControlCentre.notifyDroneState-288"><span class="linenos">288</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.notifyDroneState-289"><a href="#ControlCentre.notifyDroneState-289"><span class="linenos">289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">drone</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Notification from Drone when charging finished or Drone has broken off the charge/flight</p>
</div>


                            </div>
                            <div id="ControlCentre.notifyEVState" class="classattr">
                                        <input id="ControlCentre.notifyEVState-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">notifyEVState</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ev</span>, </span><span class="param"><span class="n">evState</span>, </span><span class="param"><span class="n">drone</span>, </span><span class="param"><span class="n">capacity</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.notifyEVState-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.notifyEVState"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.notifyEVState-291"><a href="#ControlCentre.notifyEVState-291"><span class="linenos">291</span></a>    <span class="k">def</span> <span class="nf">notifyEVState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">evState</span><span class="p">,</span> <span class="n">drone</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
</span><span id="ControlCentre.notifyEVState-292"><a href="#ControlCentre.notifyEVState-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Notification from EV - when EV has left simulation (or completed charge)&quot;&quot;&quot;</span>
</span><span id="ControlCentre.notifyEVState-293"><a href="#ControlCentre.notifyEVState-293"><span class="linenos">293</span></a>        <span class="n">charge</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre.notifyEVState-294"><a href="#ControlCentre.notifyEVState-294"><span class="linenos">294</span></a>        <span class="k">match</span> <span class="n">evState</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-295"><a href="#ControlCentre.notifyEVState-295"><span class="linenos">295</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">DRIVING</span><span class="p">:</span>            <span class="c1"># means charge complete  so calculate charge</span>
</span><span id="ControlCentre.notifyEVState-296"><a href="#ControlCentre.notifyEVState-296"><span class="linenos">296</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-297"><a href="#ControlCentre.notifyEVState-297"><span class="linenos">297</span></a>                    <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre.notifyEVState-298"><a href="#ControlCentre.notifyEVState-298"><span class="linenos">298</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span>
</span><span id="ControlCentre.notifyEVState-299"><a href="#ControlCentre.notifyEVState-299"><span class="linenos">299</span></a>
</span><span id="ControlCentre.notifyEVState-300"><a href="#ControlCentre.notifyEVState-300"><span class="linenos">300</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEREQUESTED</span><span class="p">:</span>    <span class="c1"># just log request</span>
</span><span id="ControlCentre.notifyEVState-301"><a href="#ControlCentre.notifyEVState-301"><span class="linenos">301</span></a>                <span class="k">pass</span>
</span><span id="ControlCentre.notifyEVState-302"><a href="#ControlCentre.notifyEVState-302"><span class="linenos">302</span></a>
</span><span id="ControlCentre.notifyEVState-303"><a href="#ControlCentre.notifyEVState-303"><span class="linenos">303</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEBROKENOFF</span><span class="p">:</span>    <span class="c1"># drone broke off charge so should have an entry in self.startChargeEV</span>
</span><span id="ControlCentre.notifyEVState-304"><a href="#ControlCentre.notifyEVState-304"><span class="linenos">304</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-305"><a href="#ControlCentre.notifyEVState-305"><span class="linenos">305</span></a>                    <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre.notifyEVState-306"><a href="#ControlCentre.notifyEVState-306"><span class="linenos">306</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span>
</span><span id="ControlCentre.notifyEVState-307"><a href="#ControlCentre.notifyEVState-307"><span class="linenos">307</span></a>
</span><span id="ControlCentre.notifyEVState-308"><a href="#ControlCentre.notifyEVState-308"><span class="linenos">308</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGINGFROMDRONE</span><span class="p">:</span>      <span class="c1"># charge started</span>
</span><span id="ControlCentre.notifyEVState-309"><a href="#ControlCentre.notifyEVState-309"><span class="linenos">309</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span>
</span><span id="ControlCentre.notifyEVState-310"><a href="#ControlCentre.notifyEVState-310"><span class="linenos">310</span></a>
</span><span id="ControlCentre.notifyEVState-311"><a href="#ControlCentre.notifyEVState-311"><span class="linenos">311</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">LEFTSIMULATION</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-312"><a href="#ControlCentre.notifyEVState-312"><span class="linenos">312</span></a>                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-313"><a href="#ControlCentre.notifyEVState-313"><span class="linenos">313</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-314"><a href="#ControlCentre.notifyEVState-314"><span class="linenos">314</span></a>                        <span class="k">if</span> <span class="n">drone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-315"><a href="#ControlCentre.notifyEVState-315"><span class="linenos">315</span></a>                            <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre.notifyEVState-316"><a href="#ControlCentre.notifyEVState-316"><span class="linenos">316</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-317"><a href="#ControlCentre.notifyEVState-317"><span class="linenos">317</span></a>                            <span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startChargeEV</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">()])</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre.notifyEVState-318"><a href="#ControlCentre.notifyEVState-318"><span class="linenos">318</span></a>                <span class="k">if</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-319"><a href="#ControlCentre.notifyEVState-319"><span class="linenos">319</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre.notifyEVState-320"><a href="#ControlCentre.notifyEVState-320"><span class="linenos">320</span></a>                <span class="k">elif</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-321"><a href="#ControlCentre.notifyEVState-321"><span class="linenos">321</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]]</span>
</span><span id="ControlCentre.notifyEVState-322"><a href="#ControlCentre.notifyEVState-322"><span class="linenos">322</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocatedEV</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
</span><span id="ControlCentre.notifyEVState-323"><a href="#ControlCentre.notifyEVState-323"><span class="linenos">323</span></a>
</span><span id="ControlCentre.notifyEVState-324"><a href="#ControlCentre.notifyEVState-324"><span class="linenos">324</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">WAITINGFORRENDEZVOUS</span><span class="p">:</span>   <span class="c1"># don&#39;t see this yet</span>
</span><span id="ControlCentre.notifyEVState-325"><a href="#ControlCentre.notifyEVState-325"><span class="linenos">325</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="s2">&quot;rv&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.notifyEVState-326"><a href="#ControlCentre.notifyEVState-326"><span class="linenos">326</span></a>
</span><span id="ControlCentre.notifyEVState-327"><a href="#ControlCentre.notifyEVState-327"><span class="linenos">327</span></a>            <span class="k">case</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">WAITINGFORDRONE</span><span class="p">:</span>        <span class="c1"># don&#39;t see this</span>
</span><span id="ControlCentre.notifyEVState-328"><a href="#ControlCentre.notifyEVState-328"><span class="linenos">328</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="s2">&quot;wd&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.notifyEVState-329"><a href="#ControlCentre.notifyEVState-329"><span class="linenos">329</span></a>
</span><span id="ControlCentre.notifyEVState-330"><a href="#ControlCentre.notifyEVState-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">chargePrint</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-331"><a href="#ControlCentre.notifyEVState-331"><span class="linenos">331</span></a>            <span class="n">droneID</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
</span><span id="ControlCentre.notifyEVState-332"><a href="#ControlCentre.notifyEVState-332"><span class="linenos">332</span></a>            <span class="k">if</span> <span class="n">drone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ControlCentre.notifyEVState-333"><a href="#ControlCentre.notifyEVState-333"><span class="linenos">333</span></a>                <span class="n">droneID</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">getID</span><span class="p">()</span>
</span><span id="ControlCentre.notifyEVState-334"><a href="#ControlCentre.notifyEVState-334"><span class="linenos">334</span></a>
</span><span id="ControlCentre.notifyEVState-335"><a href="#ControlCentre.notifyEVState-335"><span class="linenos">335</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="n">evState</span><span class="p">,</span> <span class="n">droneID</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">charge</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">GG</span><span class="o">.</span><span class="n">chargeLog</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Notification from EV - when EV has left simulation (or completed charge)</p>
</div>


                            </div>
                            <div id="ControlCentre.printDroneStatistics" class="classattr">
                                        <input id="ControlCentre.printDroneStatistics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">printDroneStatistics</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">brief</span>, </span><span class="param"><span class="n">version</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.printDroneStatistics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.printDroneStatistics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.printDroneStatistics-337"><a href="#ControlCentre.printDroneStatistics-337"><span class="linenos">337</span></a>    <span class="k">def</span> <span class="nf">printDroneStatistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brief</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
</span><span id="ControlCentre.printDroneStatistics-338"><a href="#ControlCentre.printDroneStatistics-338"><span class="linenos">338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Print out Drone and EV statistics for the complete run&quot;&quot;&quot;</span>
</span><span id="ControlCentre.printDroneStatistics-339"><a href="#ControlCentre.printDroneStatistics-339"><span class="linenos">339</span></a>        <span class="c1"># compute drone statistic totals</span>
</span><span id="ControlCentre.printDroneStatistics-340"><a href="#ControlCentre.printDroneStatistics-340"><span class="linenos">340</span></a>        <span class="n">tmyFlyingCount</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># used to compute distance travelled</span>
</span><span id="ControlCentre.printDroneStatistics-341"><a href="#ControlCentre.printDroneStatistics-341"><span class="linenos">341</span></a>        <span class="n">tmyFullCharges</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># count of complete charges</span>
</span><span id="ControlCentre.printDroneStatistics-342"><a href="#ControlCentre.printDroneStatistics-342"><span class="linenos">342</span></a>        <span class="n">tmyBrokenCharges</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># count of charges broken off - either by me out of charge</span>
</span><span id="ControlCentre.printDroneStatistics-343"><a href="#ControlCentre.printDroneStatistics-343"><span class="linenos">343</span></a>        <span class="n">tmyBrokenEVCharges</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># count of charges broken off - by EV leaving</span>
</span><span id="ControlCentre.printDroneStatistics-344"><a href="#ControlCentre.printDroneStatistics-344"><span class="linenos">344</span></a>        <span class="n">tmyFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>           <span class="c1"># wH i&#39;ve used flying</span>
</span><span id="ControlCentre.printDroneStatistics-345"><a href="#ControlCentre.printDroneStatistics-345"><span class="linenos">345</span></a>        <span class="n">tmyChargingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>         <span class="c1"># wH i&#39;ve used charging EVs</span>
</span><span id="ControlCentre.printDroneStatistics-346"><a href="#ControlCentre.printDroneStatistics-346"><span class="linenos">346</span></a>        <span class="n">tmyChargeMeFlyingCount</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># wh i&#39;ve charged my flying battery</span>
</span><span id="ControlCentre.printDroneStatistics-347"><a href="#ControlCentre.printDroneStatistics-347"><span class="linenos">347</span></a>        <span class="n">tmyChargeMeCount</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># wh i&#39;ve used charging my EV charging battery</span>
</span><span id="ControlCentre.printDroneStatistics-348"><a href="#ControlCentre.printDroneStatistics-348"><span class="linenos">348</span></a>        <span class="n">tmyResidualChargeKWh</span> <span class="o">=</span> <span class="mf">0.0</span>   <span class="c1"># Wh left in charge battery at end</span>
</span><span id="ControlCentre.printDroneStatistics-349"><a href="#ControlCentre.printDroneStatistics-349"><span class="linenos">349</span></a>        <span class="n">tmyResidualFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>   <span class="c1"># Wh left in flying battery at end</span>
</span><span id="ControlCentre.printDroneStatistics-350"><a href="#ControlCentre.printDroneStatistics-350"><span class="linenos">350</span></a>        <span class="n">tmyChaseCount</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># no of successful chases  (ie successfully got from rendezvous to EV)</span>
</span><span id="ControlCentre.printDroneStatistics-351"><a href="#ControlCentre.printDroneStatistics-351"><span class="linenos">351</span></a>        <span class="n">tmyBrokenChaseCount</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c1"># no of broken chases  (vehicle left after rendezvous but before drone got there)</span>
</span><span id="ControlCentre.printDroneStatistics-352"><a href="#ControlCentre.printDroneStatistics-352"><span class="linenos">352</span></a>        <span class="n">tmyChaseSteps</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># steps for succesful chases - used to compute average chase time</span>
</span><span id="ControlCentre.printDroneStatistics-353"><a href="#ControlCentre.printDroneStatistics-353"><span class="linenos">353</span></a>
</span><span id="ControlCentre.printDroneStatistics-354"><a href="#ControlCentre.printDroneStatistics-354"><span class="linenos">354</span></a>        <span class="n">tDroneDistance</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre.printDroneStatistics-355"><a href="#ControlCentre.printDroneStatistics-355"><span class="linenos">355</span></a>        <span class="n">tmyChargeMeFlyingKWh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre.printDroneStatistics-356"><a href="#ControlCentre.printDroneStatistics-356"><span class="linenos">356</span></a>        <span class="n">tmyChargeMeKWh</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ControlCentre.printDroneStatistics-357"><a href="#ControlCentre.printDroneStatistics-357"><span class="linenos">357</span></a>
</span><span id="ControlCentre.printDroneStatistics-358"><a href="#ControlCentre.printDroneStatistics-358"><span class="linenos">358</span></a>        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">):</span>
</span><span id="ControlCentre.printDroneStatistics-359"><a href="#ControlCentre.printDroneStatistics-359"><span class="linenos">359</span></a>            <span class="n">tmyFlyingCount</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span>
</span><span id="ControlCentre.printDroneStatistics-360"><a href="#ControlCentre.printDroneStatistics-360"><span class="linenos">360</span></a>            <span class="n">tmyFlyingKWh</span>            <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneFlyingWhperTimeStep</span>
</span><span id="ControlCentre.printDroneStatistics-361"><a href="#ControlCentre.printDroneStatistics-361"><span class="linenos">361</span></a>
</span><span id="ControlCentre.printDroneStatistics-362"><a href="#ControlCentre.printDroneStatistics-362"><span class="linenos">362</span></a>            <span class="n">tDroneDistance</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneStepMperTimeStep</span>
</span><span id="ControlCentre.printDroneStatistics-363"><a href="#ControlCentre.printDroneStatistics-363"><span class="linenos">363</span></a>
</span><span id="ControlCentre.printDroneStatistics-364"><a href="#ControlCentre.printDroneStatistics-364"><span class="linenos">364</span></a>            <span class="n">tmyFullCharges</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFullCharges</span>
</span><span id="ControlCentre.printDroneStatistics-365"><a href="#ControlCentre.printDroneStatistics-365"><span class="linenos">365</span></a>            <span class="n">tmyBrokenCharges</span>        <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenCharges</span>
</span><span id="ControlCentre.printDroneStatistics-366"><a href="#ControlCentre.printDroneStatistics-366"><span class="linenos">366</span></a>            <span class="n">tmyBrokenEVCharges</span>      <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenEVCharges</span>
</span><span id="ControlCentre.printDroneStatistics-367"><a href="#ControlCentre.printDroneStatistics-367"><span class="linenos">367</span></a>
</span><span id="ControlCentre.printDroneStatistics-368"><a href="#ControlCentre.printDroneStatistics-368"><span class="linenos">368</span></a>            <span class="n">tmyChargingKWh</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myEVChargingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span>
</span><span id="ControlCentre.printDroneStatistics-369"><a href="#ControlCentre.printDroneStatistics-369"><span class="linenos">369</span></a>            <span class="n">tmyChargeMeFlyingCount</span>  <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeFlyingCount</span>
</span><span id="ControlCentre.printDroneStatistics-370"><a href="#ControlCentre.printDroneStatistics-370"><span class="linenos">370</span></a>            <span class="n">tmyChargeMeFlyingKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhDroneRechargePerTimeStep</span>
</span><span id="ControlCentre.printDroneStatistics-371"><a href="#ControlCentre.printDroneStatistics-371"><span class="linenos">371</span></a>            <span class="n">tmyChargeMeCount</span>        <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeCount</span>
</span><span id="ControlCentre.printDroneStatistics-372"><a href="#ControlCentre.printDroneStatistics-372"><span class="linenos">372</span></a>            <span class="n">tmyChargeMeKWh</span>          <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChargeMeCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhDroneRechargePerTimeStep</span>
</span><span id="ControlCentre.printDroneStatistics-373"><a href="#ControlCentre.printDroneStatistics-373"><span class="linenos">373</span></a>
</span><span id="ControlCentre.printDroneStatistics-374"><a href="#ControlCentre.printDroneStatistics-374"><span class="linenos">374</span></a>            <span class="n">tmyResidualFlyingKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCharge</span>
</span><span id="ControlCentre.printDroneStatistics-375"><a href="#ControlCentre.printDroneStatistics-375"><span class="linenos">375</span></a>            <span class="n">tmyResidualChargeKWh</span>    <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myCharge</span>
</span><span id="ControlCentre.printDroneStatistics-376"><a href="#ControlCentre.printDroneStatistics-376"><span class="linenos">376</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-377"><a href="#ControlCentre.printDroneStatistics-377"><span class="linenos">377</span></a>                <span class="n">tmyChaseCount</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChaseCount</span>
</span><span id="ControlCentre.printDroneStatistics-378"><a href="#ControlCentre.printDroneStatistics-378"><span class="linenos">378</span></a>                <span class="n">tmyBrokenChaseCount</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myBrokenChaseCount</span>
</span><span id="ControlCentre.printDroneStatistics-379"><a href="#ControlCentre.printDroneStatistics-379"><span class="linenos">379</span></a>                <span class="n">tmyChaseSteps</span> <span class="o">+=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myChaseSteps</span>
</span><span id="ControlCentre.printDroneStatistics-380"><a href="#ControlCentre.printDroneStatistics-380"><span class="linenos">380</span></a>
</span><span id="ControlCentre.printDroneStatistics-381"><a href="#ControlCentre.printDroneStatistics-381"><span class="linenos">381</span></a>        <span class="c1"># alternative computation - avoiding errors from addition of large no of floating point</span>
</span><span id="ControlCentre.printDroneStatistics-382"><a href="#ControlCentre.printDroneStatistics-382"><span class="linenos">382</span></a>        <span class="c1"># tmyFlyingKWh = tmyFlyingCount * Drone.droneFlyingWhperTimeStep / 1000.</span>
</span><span id="ControlCentre.printDroneStatistics-383"><a href="#ControlCentre.printDroneStatistics-383"><span class="linenos">383</span></a>        <span class="n">tDroneDistance</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-384"><a href="#ControlCentre.printDroneStatistics-384"><span class="linenos">384</span></a>        <span class="n">tmyFlyingKWh</span>          <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-385"><a href="#ControlCentre.printDroneStatistics-385"><span class="linenos">385</span></a>        <span class="n">tmyChargingKWh</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-386"><a href="#ControlCentre.printDroneStatistics-386"><span class="linenos">386</span></a>        <span class="n">tmyChargeMeFlyingKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-387"><a href="#ControlCentre.printDroneStatistics-387"><span class="linenos">387</span></a>        <span class="n">tmyChargeMeKWh</span>        <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-388"><a href="#ControlCentre.printDroneStatistics-388"><span class="linenos">388</span></a>        <span class="n">tmyResidualFlyingKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-389"><a href="#ControlCentre.printDroneStatistics-389"><span class="linenos">389</span></a>        <span class="n">tmyResidualChargeKWh</span>  <span class="o">/=</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-390"><a href="#ControlCentre.printDroneStatistics-390"><span class="linenos">390</span></a>
</span><span id="ControlCentre.printDroneStatistics-391"><a href="#ControlCentre.printDroneStatistics-391"><span class="linenos">391</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-392"><a href="#ControlCentre.printDroneStatistics-392"><span class="linenos">392</span></a>            <span class="c1"># note chases + broken chases usually less than charge sessions total because some will break off before they get to rendezvous</span>
</span><span id="ControlCentre.printDroneStatistics-393"><a href="#ControlCentre.printDroneStatistics-393"><span class="linenos">393</span></a>            <span class="c1"># ie chases are between rendezvous point and beginning charging - indicator of efficiency of rendezvous algorithm</span>
</span><span id="ControlCentre.printDroneStatistics-394"><a href="#ControlCentre.printDroneStatistics-394"><span class="linenos">394</span></a>            <span class="k">if</span> <span class="n">tmyChaseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-395"><a href="#ControlCentre.printDroneStatistics-395"><span class="linenos">395</span></a>                <span class="n">averageChase</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmyChaseSteps</span> <span class="o">*</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">stepSecs</span><span class="p">)</span><span class="o">/</span><span class="n">tmyChaseCount</span>
</span><span id="ControlCentre.printDroneStatistics-396"><a href="#ControlCentre.printDroneStatistics-396"><span class="linenos">396</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-397"><a href="#ControlCentre.printDroneStatistics-397"><span class="linenos">397</span></a>                <span class="n">averageChase</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ControlCentre.printDroneStatistics-398"><a href="#ControlCentre.printDroneStatistics-398"><span class="linenos">398</span></a>
</span><span id="ControlCentre.printDroneStatistics-399"><a href="#ControlCentre.printDroneStatistics-399"><span class="linenos">399</span></a>        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="ControlCentre.printDroneStatistics-400"><a href="#ControlCentre.printDroneStatistics-400"><span class="linenos">400</span></a>        <span class="c1"># all done, dump the distance travelled by the drones and KW used</span>
</span><span id="ControlCentre.printDroneStatistics-401"><a href="#ControlCentre.printDroneStatistics-401"><span class="linenos">401</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1">#  tidy up after the ....</span>
</span><span id="ControlCentre.printDroneStatistics-402"><a href="#ControlCentre.printDroneStatistics-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">brief</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-403"><a href="#ControlCentre.printDroneStatistics-403"><span class="linenos">403</span></a>            <span class="n">sumoVersion</span> <span class="o">=</span> <span class="n">traci</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span>
</span><span id="ControlCentre.printDroneStatistics-404"><a href="#ControlCentre.printDroneStatistics-404"><span class="linenos">404</span></a>            <span class="n">runstring</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
</span><span id="ControlCentre.printDroneStatistics-405"><a href="#ControlCentre.printDroneStatistics-405"><span class="linenos">405</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Date</span><span class="se">\t</span><span class="s2">Rv</span><span class="se">\t</span><span class="s2">Once</span><span class="se">\t</span><span class="s2">Output</span><span class="se">\t</span><span class="s2">wE</span><span class="se">\t</span><span class="s2">wU</span><span class="se">\t</span><span class="s2">radius</span><span class="se">\t</span><span class="s2">Steps</span><span class="se">\t</span><span class="s2"># Drones&quot;</span>
</span><span id="ControlCentre.printDroneStatistics-406"><a href="#ControlCentre.printDroneStatistics-406"><span class="linenos">406</span></a>                  <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Distance</span><span class="se">\t</span><span class="s2">FlyKWh</span><span class="se">\t</span><span class="s2">chKWh</span><span class="se">\t</span><span class="s2">FlyChgKWh</span><span class="se">\t</span><span class="s2">ChgKWh</span><span class="se">\t</span><span class="s2">rFlyKWh</span><span class="se">\t</span><span class="s2">rChKWh&quot;</span>
</span><span id="ControlCentre.printDroneStatistics-407"><a href="#ControlCentre.printDroneStatistics-407"><span class="linenos">407</span></a>                  <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"># EVs</span><span class="se">\t</span><span class="s2">EVChg</span><span class="se">\t</span><span class="s2">EVgap</span><span class="se">\t</span><span class="s2">Full</span><span class="se">\t</span><span class="s2">brDrone</span><span class="se">\t</span><span class="s2">brEV</span><span class="se">\t</span><span class="s2">Chases</span><span class="se">\t</span><span class="s2">Avg Chase</span><span class="se">\t</span><span class="s2">Brk Chase&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-408"><a href="#ControlCentre.printDroneStatistics-408"><span class="linenos">408</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre.printDroneStatistics-409"><a href="#ControlCentre.printDroneStatistics-409"><span class="linenos">409</span></a>                  <span class="p">(</span><span class="n">timeStamp</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">onlyChargeOnce</span><span class="p">,</span>
</span><span id="ControlCentre.printDroneStatistics-410"><a href="#ControlCentre.printDroneStatistics-410"><span class="linenos">410</span></a>                   <span class="n">GG</span><span class="o">.</span><span class="n">dronePrint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-411"><a href="#ControlCentre.printDroneStatistics-411"><span class="linenos">411</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span><span class="p">,</span> <span class="n">tDroneDistance</span><span class="p">,</span> <span class="n">tmyFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargingKWh</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-412"><a href="#ControlCentre.printDroneStatistics-412"><span class="linenos">412</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre.printDroneStatistics-413"><a href="#ControlCentre.printDroneStatistics-413"><span class="linenos">413</span></a>                  <span class="p">(</span><span class="n">tmyChargeMeFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargeMeKWh</span><span class="p">,</span> <span class="n">tmyResidualFlyingKWh</span><span class="p">,</span> <span class="n">tmyResidualChargeKWh</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-414"><a href="#ControlCentre.printDroneStatistics-414"><span class="linenos">414</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre.printDroneStatistics-415"><a href="#ControlCentre.printDroneStatistics-415"><span class="linenos">415</span></a>                  <span class="p">(</span><span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeSteps</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeGap</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-416"><a href="#ControlCentre.printDroneStatistics-416"><span class="linenos">416</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmyFullCharges</span><span class="p">,</span> <span class="n">tmyBrokenCharges</span><span class="p">,</span> <span class="n">tmyBrokenEVCharges</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-417"><a href="#ControlCentre.printDroneStatistics-417"><span class="linenos">417</span></a>
</span><span id="ControlCentre.printDroneStatistics-418"><a href="#ControlCentre.printDroneStatistics-418"><span class="linenos">418</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-419"><a href="#ControlCentre.printDroneStatistics-419"><span class="linenos">419</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmyChaseCount</span><span class="p">,</span> <span class="n">averageChase</span><span class="p">,</span> <span class="n">tmyBrokenChaseCount</span><span class="p">,</span> <span class="n">runstring</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">sumoVersion</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-420"><a href="#ControlCentre.printDroneStatistics-420"><span class="linenos">420</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-421"><a href="#ControlCentre.printDroneStatistics-421"><span class="linenos">421</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runstring</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">sumoVersion</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-422"><a href="#ControlCentre.printDroneStatistics-422"><span class="linenos">422</span></a>
</span><span id="ControlCentre.printDroneStatistics-423"><a href="#ControlCentre.printDroneStatistics-423"><span class="linenos">423</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-424"><a href="#ControlCentre.printDroneStatistics-424"><span class="linenos">424</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary Statistics:</span><span class="se">\t\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timeStamp</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-425"><a href="#ControlCentre.printDroneStatistics-425"><span class="linenos">425</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Model flags:</span><span class="se">\t</span><span class="s2">Rendezvous: </span><span class="si">{!r}</span><span class="se">\t</span><span class="s2">Charge Once: </span><span class="si">{!r}</span><span class="se">\t</span><span class="s2">Drone print: </span><span class="si">{!r}</span><span class="se">\n\t</span><span class="s2">Energy Weight: &quot;</span>
</span><span id="ControlCentre.printDroneStatistics-426"><a href="#ControlCentre.printDroneStatistics-426"><span class="linenos">426</span></a>                  <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="s2">Urgency Weight: </span><span class="si">{:.1f}</span><span class="se">\t</span><span class="s2">Proximity radius(m): </span><span class="si">{:.0f}</span><span class="se">\t</span><span class="s2">Time steps: </span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre.printDroneStatistics-427"><a href="#ControlCentre.printDroneStatistics-427"><span class="linenos">427</span></a>                  <span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">onlyChargeOnce</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">dronePrint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wEnergy</span><span class="p">,</span>
</span><span id="ControlCentre.printDroneStatistics-428"><a href="#ControlCentre.printDroneStatistics-428"><span class="linenos">428</span></a>                   <span class="bp">self</span><span class="o">.</span><span class="n">wUrgency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximityRadius</span><span class="p">,</span> <span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-429"><a href="#ControlCentre.printDroneStatistics-429"><span class="linenos">429</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Drone Totals:</span><span class="se">\t</span><span class="s2">(</span><span class="si">%i</span><span class="s2"> drones)</span><span class="se">\n\t\t</span><span class="s2">Distance Km:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">%.2f</span><span class="se">\n\t\t</span><span class="s2">Charging KWh:</span><span class="se">\t</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre.printDroneStatistics-430"><a href="#ControlCentre.printDroneStatistics-430"><span class="linenos">430</span></a>                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span><span class="p">,</span> <span class="n">tDroneDistance</span><span class="p">,</span> <span class="n">tmyFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargingKWh</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-431"><a href="#ControlCentre.printDroneStatistics-431"><span class="linenos">431</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Drone Charger usage:</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="se">\n\t\t</span><span class="s2">Charge KWh:</span><span class="se">\t</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre.printDroneStatistics-432"><a href="#ControlCentre.printDroneStatistics-432"><span class="linenos">432</span></a>                  <span class="p">(</span><span class="n">tmyChargeMeFlyingKWh</span><span class="p">,</span> <span class="n">tmyChargeMeKWh</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-433"><a href="#ControlCentre.printDroneStatistics-433"><span class="linenos">433</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Residuals:</span><span class="se">\n\t\t</span><span class="s2">Flying KWh:</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\n\t\t</span><span class="s2">Charging KWh:</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre.printDroneStatistics-434"><a href="#ControlCentre.printDroneStatistics-434"><span class="linenos">434</span></a>                  <span class="p">(</span><span class="n">tmyResidualFlyingKWh</span><span class="p">,</span> <span class="n">tmyResidualChargeKWh</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-435"><a href="#ControlCentre.printDroneStatistics-435"><span class="linenos">435</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">EV Totals:</span><span class="se">\t</span><span class="s2">(</span><span class="si">%i</span><span class="s2"> EVs)</span><span class="se">\n\t\t</span><span class="s2">Charge KWh:</span><span class="se">\t</span><span class="si">%.1f</span><span class="se">\n\t\t</span><span class="s2">Charge Gap KWh:</span><span class="se">\t</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre.printDroneStatistics-436"><a href="#ControlCentre.printDroneStatistics-436"><span class="linenos">436</span></a>                  <span class="p">(</span><span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeSteps</span> <span class="o">*</span> <span class="n">Drone</span><span class="o">.</span><span class="n">d0Type</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">EV</span><span class="o">.</span><span class="n">evChargeGap</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">*</span> <span class="n">EV</span><span class="o">.</span><span class="n">evCount</span><span class="p">)))</span>
</span><span id="ControlCentre.printDroneStatistics-437"><a href="#ControlCentre.printDroneStatistics-437"><span class="linenos">437</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Charge Sessions:</span><span class="se">\n\t\t\t</span><span class="s2">Full charges:</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\n\t\t\t</span><span class="s2">Part (drone):</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="se">\n\t\t\t</span><span class="s2">Part (ev):</span><span class="se">\t</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</span><span id="ControlCentre.printDroneStatistics-438"><a href="#ControlCentre.printDroneStatistics-438"><span class="linenos">438</span></a>                  <span class="p">(</span><span class="n">tmyFullCharges</span><span class="p">,</span> <span class="n">tmyBrokenCharges</span><span class="p">,</span> <span class="n">tmyBrokenEVCharges</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-439"><a href="#ControlCentre.printDroneStatistics-439"><span class="linenos">439</span></a>
</span><span id="ControlCentre.printDroneStatistics-440"><a href="#ControlCentre.printDroneStatistics-440"><span class="linenos">440</span></a>            <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">modelRendezvous</span><span class="p">:</span>
</span><span id="ControlCentre.printDroneStatistics-441"><a href="#ControlCentre.printDroneStatistics-441"><span class="linenos">441</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Successful chases: </span><span class="si">%i</span><span class="se">\t</span><span class="s2">Average chase time: </span><span class="si">%.1f</span><span class="s2">s</span><span class="se">\t</span><span class="s2">broken Chases: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="ControlCentre.printDroneStatistics-442"><a href="#ControlCentre.printDroneStatistics-442"><span class="linenos">442</span></a>                      <span class="p">(</span><span class="n">tmyChaseCount</span><span class="p">,</span> <span class="n">averageChase</span><span class="p">,</span> <span class="n">tmyBrokenChaseCount</span><span class="p">))</span>
</span><span id="ControlCentre.printDroneStatistics-443"><a href="#ControlCentre.printDroneStatistics-443"><span class="linenos">443</span></a>
</span><span id="ControlCentre.printDroneStatistics-444"><a href="#ControlCentre.printDroneStatistics-444"><span class="linenos">444</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Discrete Drone data:&quot;</span><span class="p">)</span>
</span><span id="ControlCentre.printDroneStatistics-445"><a href="#ControlCentre.printDroneStatistics-445"><span class="linenos">445</span></a>            <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocatedDrone</span><span class="p">)):</span>
</span><span id="ControlCentre.printDroneStatistics-446"><a href="#ControlCentre.printDroneStatistics-446"><span class="linenos">446</span></a>                <span class="n">droneDistance</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneStepMperTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-447"><a href="#ControlCentre.printDroneStatistics-447"><span class="linenos">447</span></a>                <span class="n">droneFlyingKWh</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">droneFlyingWhperTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-448"><a href="#ControlCentre.printDroneStatistics-448"><span class="linenos">448</span></a>                <span class="n">droneChargeKWh</span> <span class="o">=</span> <span class="n">drone</span><span class="o">.</span><span class="n">myEVChargingCount</span> <span class="o">*</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDt</span><span class="o">.</span><span class="n">WhEVChargeRatePerTimeStep</span> <span class="o">/</span> <span class="mf">1000.</span>
</span><span id="ControlCentre.printDroneStatistics-449"><a href="#ControlCentre.printDroneStatistics-449"><span class="linenos">449</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">drone:</span><span class="si">{}</span><span class="se">\t</span><span class="s2">Km:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">Charge KW:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">FlyingKW:</span><span class="si">{:.2f}</span><span class="se">\t</span><span class="s2">Residual (chargeWh:</span><span class="si">{:.0f}</span><span class="s2"> flyingWh:</span><span class="si">{:.0f}</span><span class="s2">)&quot;</span>
</span><span id="ControlCentre.printDroneStatistics-450"><a href="#ControlCentre.printDroneStatistics-450"><span class="linenos">450</span></a>                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">myID</span><span class="p">,</span> <span class="n">droneDistance</span><span class="p">,</span> <span class="n">droneChargeKWh</span><span class="p">,</span> <span class="n">droneFlyingKWh</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">myCharge</span><span class="p">,</span> <span class="n">drone</span><span class="o">.</span><span class="n">myFlyingCharge</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Print out Drone and EV statistics for the complete run</p>
</div>


                            </div>
                            <div id="ControlCentre.requestCharge" class="classattr">
                                        <input id="ControlCentre.requestCharge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requestCharge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ev</span>, </span><span class="param"><span class="n">capacity</span>, </span><span class="param"><span class="n">requestedWh</span><span class="o">=</span><span class="mf">2000.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.requestCharge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.requestCharge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.requestCharge-452"><a href="#ControlCentre.requestCharge-452"><span class="linenos">452</span></a>    <span class="k">def</span> <span class="nf">requestCharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">requestedWh</span><span class="o">=</span><span class="mf">2000.</span><span class="p">):</span>
</span><span id="ControlCentre.requestCharge-453"><a href="#ControlCentre.requestCharge-453"><span class="linenos">453</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;request for charge from EV&quot;&quot;&quot;</span>
</span><span id="ControlCentre.requestCharge-454"><a href="#ControlCentre.requestCharge-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">requestedWh</span>
</span><span id="ControlCentre.requestCharge-455"><a href="#ControlCentre.requestCharge-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="n">GG</span><span class="o">.</span><span class="n">chargePrint</span><span class="p">:</span>
</span><span id="ControlCentre.requestCharge-456"><a href="#ControlCentre.requestCharge-456"><span class="linenos">456</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{!r}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="se">\t</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">ss</span><span class="o">.</span><span class="n">timeStep</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">getID</span><span class="p">(),</span> <span class="n">EV</span><span class="o">.</span><span class="n">EVState</span><span class="o">.</span><span class="n">CHARGEREQUESTED</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">requestedWh</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">GG</span><span class="o">.</span><span class="n">chargeLog</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>request for charge from EV</p>
</div>


                            </div>
                            <div id="ControlCentre.setMaxDrones" class="classattr">
                                        <input id="ControlCentre.setMaxDrones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setMaxDrones</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pmaxDrones</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.setMaxDrones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.setMaxDrones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.setMaxDrones-458"><a href="#ControlCentre.setMaxDrones-458"><span class="linenos">458</span></a>    <span class="k">def</span> <span class="nf">setMaxDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmaxDrones</span><span class="p">):</span>
</span><span id="ControlCentre.setMaxDrones-459"><a href="#ControlCentre.setMaxDrones-459"><span class="linenos">459</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; update maxDrones - when --z option is used drones are limited to those in the add file&quot;&quot;&quot;</span>
</span><span id="ControlCentre.setMaxDrones-460"><a href="#ControlCentre.setMaxDrones-460"><span class="linenos">460</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">=</span> <span class="n">pmaxDrones</span>
</span><span id="ControlCentre.setMaxDrones-461"><a href="#ControlCentre.setMaxDrones-461"><span class="linenos">461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">syncSpawnedDrones</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>update maxDrones - when --z option is used drones are limited to those in the add file</p>
</div>


                            </div>
                            <div id="ControlCentre.syncSpawnedDrones" class="classattr">
                                        <input id="ControlCentre.syncSpawnedDrones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">syncSpawnedDrones</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.syncSpawnedDrones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.syncSpawnedDrones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.syncSpawnedDrones-463"><a href="#ControlCentre.syncSpawnedDrones-463"><span class="linenos">463</span></a>    <span class="k">def</span> <span class="nf">syncSpawnedDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre.syncSpawnedDrones-464"><a href="#ControlCentre.syncSpawnedDrones-464"><span class="linenos">464</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;if we&#39;ve generated drones from POI definitions in the add file we need to update our spawnedDrone count&quot;&quot;&quot;</span>
</span><span id="ControlCentre.syncSpawnedDrones-465"><a href="#ControlCentre.syncSpawnedDrones-465"><span class="linenos">465</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span> <span class="o">=</span> <span class="n">Drone</span><span class="o">.</span><span class="n">getIDCount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>if we've generated drones from POI definitions in the add file we need to update our spawnedDrone count</p>
</div>


                            </div>
                            <div id="ControlCentre.tidyDrones" class="classattr">
                                        <input id="ControlCentre.tidyDrones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tidyDrones</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.tidyDrones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.tidyDrones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.tidyDrones-467"><a href="#ControlCentre.tidyDrones-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="nf">tidyDrones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre.tidyDrones-468"><a href="#ControlCentre.tidyDrones-468"><span class="linenos">468</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;remove any dummy vehicles left after all vehicles have left - ie simulation has finished&quot;&quot;&quot;</span>
</span><span id="ControlCentre.tidyDrones-469"><a href="#ControlCentre.tidyDrones-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertedDummies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.tidyDrones-470"><a href="#ControlCentre.tidyDrones-470"><span class="linenos">470</span></a>            <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="ControlCentre.tidyDrones-471"><a href="#ControlCentre.tidyDrones-471"><span class="linenos">471</span></a>                <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">myDummyEVInserted</span><span class="p">:</span>
</span><span id="ControlCentre.tidyDrones-472"><a href="#ControlCentre.tidyDrones-472"><span class="linenos">472</span></a>                    <span class="n">drone</span><span class="o">.</span><span class="n">dummyEVHide</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>remove any dummy vehicles left after all vehicles have left - ie simulation has finished</p>
</div>


                            </div>
                            <div id="ControlCentre.update" class="classattr">
                                        <input id="ControlCentre.update-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ControlCentre.update-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ControlCentre.update"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ControlCentre.update-474"><a href="#ControlCentre.update-474"><span class="linenos">474</span></a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ControlCentre.update-475"><a href="#ControlCentre.update-475"><span class="linenos">475</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Management of &#39;control centre&#39; executed by simulation on every step&quot;&quot;&quot;</span>
</span><span id="ControlCentre.update-476"><a href="#ControlCentre.update-476"><span class="linenos">476</span></a>        <span class="n">availableDrones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxDrones</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spawnedDrones</span>
</span><span id="ControlCentre.update-477"><a href="#ControlCentre.update-477"><span class="linenos">477</span></a>        <span class="k">if</span> <span class="n">availableDrones</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ControlCentre.update-478"><a href="#ControlCentre.update-478"><span class="linenos">478</span></a>            <span class="n">urgencyList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcUrgency</span><span class="p">()</span>
</span><span id="ControlCentre.update-479"><a href="#ControlCentre.update-479"><span class="linenos">479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">allocateDrones</span><span class="p">(</span><span class="n">urgencyList</span><span class="p">)</span>
</span><span id="ControlCentre.update-480"><a href="#ControlCentre.update-480"><span class="linenos">480</span></a>            <span class="k">del</span> <span class="n">urgencyList</span>
</span><span id="ControlCentre.update-481"><a href="#ControlCentre.update-481"><span class="linenos">481</span></a>        <span class="c1"># Control centre manages parking/charging of drones</span>
</span><span id="ControlCentre.update-482"><a href="#ControlCentre.update-482"><span class="linenos">482</span></a>        <span class="c1"># each EV &#39;manages&#39; the drone allocated to them</span>
</span><span id="ControlCentre.update-483"><a href="#ControlCentre.update-483"><span class="linenos">483</span></a>        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeDrones</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">needChargeDrones</span><span class="p">:</span>
</span><span id="ControlCentre.update-484"><a href="#ControlCentre.update-484"><span class="linenos">484</span></a>            <span class="n">drone</span><span class="o">.</span><span class="n">parkingUpdate</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Management of 'control centre' executed by simulation on every step</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>